<!DOCTYPE html>
<html lang="zh-Hans">







<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="preconnect" href="//www.googletagmanager.com">
	<link rel="preconnect" href="//zz.bdstatic.com">
	<link rel="preconnect" href="//sp0.baidu.com">
	<link rel="preconnect" href="//www.google-analytics.com">
	<link rel="preconnect" href="//cdn1.lncld.net">
	<link rel="preconnect" href="//unpkg.com">
	<link rel="preconnect" href="//app-router.leancloud.cn">
	<link rel="preconnect" href="//9qpuwspm.api.lncld.net">
	<link rel="preconnect" href="//gravatar.loli.net">

	<title>Process Memory Internals | Icegrave</title>

	<meta name="HandheldFriendly" content="True">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
	<meta name="generator" content="hexo">
	<meta name="author" content="Heart-Shaped Box">
	<meta name="description" content>

	
	<meta name="keywords" content>
	

	
	<link rel="shortcut icon" href="https://mubai.oss-cn-hangzhou.aliyuncs.com/icon.png">
	<link rel="apple-touch-icon" href="https://mubai.oss-cn-hangzhou.aliyuncs.com/icon.png">
	

	
	<meta name="theme-color" content="#3c484e">
	<meta name="msapplication-TileColor" content="#3c484e">
	

	

	

	<meta property="og:site_name" content="Icegrave">
	<meta property="og:type" content="article">
	<meta property="og:title" content="Process Memory Internals | Icegrave">
	<meta property="og:description" content>
	<meta property="og:url" content="http://yoursite.com/2020/03/09/memfor-7/">

	
	<meta property="article:published_time" content="2020-03-09T18:03:00+08:00"> 
	<meta property="article:author" content="Heart-Shaped Box">
	<meta property="article:published_first" content="Icegrave, /2020/03/09/memfor-7/">
	

	
	
	<link rel="stylesheet" href="/css/allinonecss.min.css">

	
	
	
</head>
<body class="post-template">
	<div class="site-wrapper">
		




<header class="site-header post-site-header outer">
    <div class="inner">
        
<nav class="site-nav"> 
    <div class="site-nav-left">
        <ul class="nav">
            <li>
                
                <a href="/" title="Home">HOME</a>
                
            </li>
            
            
            <li>
                <a href="/about" title="ABOUT">ABOUT</a>
            </li>
            
            <li>
                <a href="/archives" title="ARCHIVES">ARCHIVES</a>
            </li>
            
            
        </ul> 
    </div>
    
    <div class="search-button-area">
        <a href="#search" class="search-button">Search ...</a>
    </div>
     
    <div class="site-nav-right">
        
        <a href="#search" class="search-button">Search ...</a>
         
        
<div class="social-links">
    
    <a class="social-link" title="weibo" href="https://weibo.com/" target="_blank" rel="noopener">
        <svg viewbox="0 0 1141 1024" xmlns="http://www.w3.org/2000/svg"><path d="M916.48 518.144q27.648 21.504 38.912 51.712t9.216 62.976-14.336 65.536-31.744 59.392q-34.816 48.128-78.848 81.92t-91.136 56.32-94.72 35.328-89.6 18.944-75.264 7.68-51.712 1.536-49.152-2.56-68.096-10.24-78.336-21.504-79.872-36.352-74.24-55.296-59.904-78.848q-16.384-29.696-22.016-63.488t-5.632-86.016q0-22.528 7.68-51.2t27.136-63.488 53.248-75.776 86.016-90.112q51.2-48.128 105.984-85.504t117.248-57.856q28.672-10.24 63.488-11.264t57.344 11.264q10.24 11.264 19.456 23.04t12.288 29.184q3.072 14.336 0.512 27.648t-5.632 26.624-5.12 25.6 2.048 22.528q17.408 2.048 33.792-1.536t31.744-9.216 31.232-11.776 33.28-9.216q27.648-5.12 54.784-4.608t49.152 7.68 36.352 22.016 17.408 38.4q2.048 14.336-2.048 26.624t-8.704 23.04-7.168 22.016 1.536 23.552q3.072 7.168 14.848 13.312t27.136 12.288 32.256 13.312 29.184 16.384zM658.432 836.608q26.624-16.384 53.76-45.056t44.032-64 18.944-75.776-20.48-81.408q-19.456-33.792-47.616-57.344t-62.976-37.376-74.24-19.968-80.384-6.144q-78.848 0-139.776 16.384t-105.472 43.008-72.192 60.416-38.912 68.608q-11.264 33.792-6.656 67.072t20.992 62.976 42.496 53.248 57.856 37.888q58.368 25.6 119.296 32.256t116.224 0.512 100.864-21.504 74.24-33.792zM524.288 513.024q20.48 8.192 38.912 18.432t32.768 27.648q10.24 12.288 17.92 30.72t10.752 39.424 1.536 42.496-9.728 38.912q-8.192 18.432-19.968 37.376t-28.672 35.328-40.448 29.184-57.344 18.944q-61.44 11.264-117.76-11.264t-88.064-74.752q-12.288-39.936-13.312-70.656t16.384-66.56q13.312-27.648 40.448-51.712t62.464-38.912 75.264-17.408 78.848 12.8zM361.472 764.928q37.888 3.072 57.856-18.432t21.504-48.128-15.36-47.616-52.736-16.896q-27.648 3.072-43.008 23.552t-17.408 43.52 9.728 42.496 39.424 21.504zM780.288 6.144q74.752 0 139.776 19.968t113.664 57.856 76.288 92.16 27.648 122.88q0 33.792-16.384 50.688t-35.328 17.408-35.328-14.336-16.384-45.568q0-40.96-22.528-77.824t-59.392-64.512-84.48-43.52-96.768-15.872q-31.744 0-47.104-15.36t-14.336-34.304 18.944-34.304 51.712-15.36zM780.288 169.984q95.232 0 144.384 48.64t49.152 146.944q0 30.72-10.24 43.52t-22.528 11.264-22.528-14.848-10.24-35.84q0-60.416-34.816-96.256t-93.184-35.84q-19.456 0-28.672-10.752t-9.216-23.04 9.728-23.04 28.16-10.752z"/></svg>
    </a>
    
    
    <a class="social-link" title="github" href="https://github.com/Icegrave0391" target="_blank" rel="noopener">
        <svg viewbox="0 0 1049 1024" xmlns="http://www.w3.org/2000/svg"><path d="M524.979332 0C234.676191 0 0 234.676191 0 524.979332c0 232.068678 150.366597 428.501342 358.967656 498.035028 26.075132 5.215026 35.636014-11.299224 35.636014-25.205961 0-12.168395-0.869171-53.888607-0.869171-97.347161-146.020741 31.290159-176.441729-62.580318-176.441729-62.580318-23.467619-60.841976-58.234462-76.487055-58.234463-76.487055-47.804409-32.15933 3.476684-32.15933 3.476685-32.15933 53.019436 3.476684 80.83291 53.888607 80.83291 53.888607 46.935238 79.963739 122.553122 57.365291 152.97411 43.458554 4.345855-33.897672 18.252593-57.365291 33.028501-70.402857-116.468925-12.168395-239.022047-57.365291-239.022047-259.012982 0-57.365291 20.860106-104.300529 53.888607-140.805715-5.215026-13.037566-23.467619-66.926173 5.215027-139.067372 0 0 44.327725-13.906737 144.282399 53.888607 41.720212-11.299224 86.917108-17.383422 131.244833-17.383422s89.524621 6.084198 131.244833 17.383422C756.178839 203.386032 800.506564 217.29277 800.506564 217.29277c28.682646 72.1412 10.430053 126.029806 5.215026 139.067372 33.897672 36.505185 53.888607 83.440424 53.888607 140.805715 0 201.64769-122.553122 245.975415-239.891218 259.012982 19.121764 16.514251 35.636014 47.804409 35.636015 97.347161 0 70.402857-0.869171 126.898978-0.869172 144.282399 0 13.906737 9.560882 30.420988 35.636015 25.205961 208.601059-69.533686 358.967656-265.96635 358.967655-498.035028C1049.958663 234.676191 814.413301 0 524.979332 0z"/></svg>
    </a>
    
    
    <a class="social-link" title="facebook" href="https://facebook" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

    </a>
    
    
    <a class="social-link" title="twitter" href="https://twitter.com" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

    </a>
    
    
    
    
</div>
    </div>
</nav>
    </div>
</header>


<div id="site-main" class="site-main outer" role="main">
    <div class="inner">
        <header class="post-full-header">
            <div class="post-full-meta">
                <time class="post-full-meta-date" datetime="2020-03-09T10:02:31.000Z">
                    2020-03-09
                </time>
                
                <span class="date-divider">/</span>
                
                <a href="/categories/memory-forensics/">memory forensics</a>&nbsp;&nbsp;
                
                
            </div>
            <h1 class="post-full-title">Process Memory Internals</h1>
        </header>
        <div class="post-full no-image">
            
            <div class="post-full-content">
                <article id="photoswipe" class="markdown-body">
                    <h2 id="7-Process-Memory-Internals"><a href="#7-Process-Memory-Internals" class="headerlink" title="7 Process Memory Internals"></a>7 Process Memory Internals</h2><p>This chapter analyzes the various application programming interfaces (APIs) used for allocating the different data types and examines how to enumerate process memory regions via memory forensics.</p>
<h3 id="gt-What’s-in-Process-Memory"><a href="#gt-What’s-in-Process-Memory" class="headerlink" title="&gt; What’s in Process Memory?"></a>&gt; What’s in Process Memory?</h3><p>As you know, each process has its owen private view of memory in this range(upper bounds of the range can be vary between of operating systems).</p>
<p>We simply represented the highest value as <code>MmHighestUserAddress</code>.</p>
<blockquote>
<p>This is a symbol in the NT module that you can query with a debugger or inside Volatility’s <code>volshell</code> plugin.</p>
</blockquote>
<p><img alt="image-20200309151913862" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnpa1y6n7j30e10dgdgk.jpg" data-index="0" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnpa1y6n7j30e10dgdgk.jpg"></p>
<p>It’s important to know that <strong>the positions of the ranges are not constant, especially on systems that levergae address spase layout randomization(ASLR)</strong>.</p>
<blockquote>
<p>the thread stacks can exist below or above the process executable, or the ranges containing mapped files can be interspersed throughout the entire process space, not gathered contiguously as the diagram above shows.</p>
</blockquote>
<ul>
<li><p><code>Dynamic linked libraries (DLLs)</code>: This area represents <strong>shared libraries (DLLs) that were loaded into the address space</strong>, either intentionally by the process or forcefully through library injection.</p>
</li>
<li><p><code>Environment variables</code>: This range of memory <strong>stores the process’ environment variables, such as its executable paths, temporary directories, home folders</strong>, and so on.</p>
</li>
<li><p><code>Process Environment Block (PEB)</code>: An extremely useful structure that <strong>tells you where to find several of the other items in this list</strong>, including the DLLs, heaps, and environment variables. It also contains the process’ command line arguments, its current working directory, and its standard handles.</p>
</li>
<li><p><code>Process heaps</code>: Where you can find a majority of the dynamic input that the process receives. </p>
<blockquote>
<p>For example, variable-length text that you type into e-mail or documents is often placed on the heap, as is data sent or received over network sockets.</p>
</blockquote>
</li>
<li><p><code>Thread stacks</code>: <strong>Each thread has a dedicated range of process memory set aside for its runtime stack</strong>. This is where you can find function arguments, return addresses (allowing you to reconstruct call history), and local variables.</p>
</li>
<li><p><code>Mapped files and application data</code>: This item is left intentionally vague because the content really depends on the process. <strong>Mapped files represent content from files on disk, which could be configuration data, documents, and so on</strong>. <strong>Application data is anything the process needs to perform its intended duties</strong>.</p>
</li>
<li><p><code>Executable</code>: The process executable contains <strong>the primary body of code and read/ write variables for the application</strong>. This data may be compressed or encrypted on disk, <strong>but once loaded into memory, it unpacks, enabling you to dump plain-text code back to disk</strong>.</p>
</li>
</ul>
<h3 id="Memory-Allocation-APIs"><a href="#Memory-Allocation-APIs" class="headerlink" title="Memory Allocation APIs"></a>Memory Allocation APIs</h3><p><img alt="image-20200309152939761" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnpkwg0pvj30ox0f9q5l.jpg" data-index="1" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnpkwg0pvj30ox0f9q5l.jpg"></p>
<p>QUESTION❓</p>
<p>These two virtual allocation functions are also the only ones that allow the caller to reserve memory (that is, set it aside) before committing it. This allows applications to “save” a large region of virtually contiguous memory for later use, without tying up the underlying physical pages in the meantime.</p>
<p>WHY？</p>
<h3 id="gt-Enumerating-Process-Memory"><a href="#gt-Enumerating-Process-Memory" class="headerlink" title="&gt; Enumerating Process Memory"></a>&gt; Enumerating Process Memory</h3><h4 id="gt-gt-Process-Page-Tables"><a href="#gt-gt-Process-Page-Tables" class="headerlink" title="&gt;&gt; Process Page Tables"></a>&gt;&gt; Process Page Tables</h4><p>We can use <code>memmap</code> and <code>memdump</code> plugins to list and extract all pages accessible to a process.</p>
<blockquote>
<p>In this case, accessible includes kernel mode addresses because even threads that start in user memory transition into kernel memory when system APIs are called.</p>
</blockquote>
<p><img alt="image-20200309154721770" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnq3brf4gj30fw0e0my0.jpg" data-index="2" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnq3brf4gj30fw0e0my0.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python vol.py -f memory.dmp --profile=Win7SP0x64 memmap –p 864</span><br></pre></td></tr></table></figure>
<p><img alt="image-20200309154752063" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnq3ugu07j30mb0aidh4.jpg" data-index="3" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnq3ugu07j30mb0aidh4.jpg"></p>
<p>and below:</p>
<p><img alt="image-20200309154806825" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnq43wktzj30md08pwfp.jpg" data-index="4" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnq43wktzj30md08pwfp.jpg"></p>
<p>Although the system’s default page size is 4KB (<code>0x1000</code> bytes hex), you can see a few pages of size <code>0x200000</code>, which is 2MB. These are Page Size Entry (PSE) pages.</p>
<ul>
<li><p><code>DumpFileOffset</code>: This value specifies the offset of the corresponding page in the file produced by the <code>memdump</code> plugin. </p>
<blockquote>
<p>Because process address spaces are sparse—holes or gaps exist between available pages—the output file is also sparse. For example, the data at virtual address <code>0xff4c1000</code> maps to physical offset <code>0x151b77000</code> (5.2GB), but your output file for this process will be nowhere near that large. Thus, the <code>DumpFileOffset</code> column tells you where to find the contents of <code>0xff4c1000</code> in your output file (<code>0x2a3000</code>). </p>
</blockquote>
</li>
</ul>
<p><code>memdump</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ python vol.py -f memory.dmp --profile=Win7SP1x64 memdump -p 864 -D OUTDIR</span><br><span class="line">$ ls -alh OUTDIR/864.dmp </span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">-rw-r--r-- 1 michael staff           434M Mar 14 14:51 864.dmp</span><br></pre></td></tr></table></figure>
<p><img alt="image-20200309160654094" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnqnnldlhj30lo0frgov.jpg" data-index="5" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnqnnldlhj30lo0frgov.jpg"></p>
<h3 id="gt-Virtual-Address-Descriptors"><a href="#gt-Virtual-Address-Descriptors" class="headerlink" title="&gt; Virtual Address Descriptors"></a>&gt; Virtual Address Descriptors</h3><p>A process’ VAD tree describes the layout of its memory segments at a slightly higher level than the page tables. </p>
<p><em>The operating system, not the CPU, defines and maintains these data structures.</em></p>
<blockquote>
<p>VADs contain the names of memory-mapped files, the total number of pages in the region, the initial protection (read, write, execute), and several other flags that can tell you a lot about what type of data the regions contain.</p>
</blockquote>
<p>Each node in the tree <strong>represents one range in process virtual memory</strong>. A node that describes a memory range lower than its parent appears on the left, and a node that describes a higher range appears on the right：</p>
<p><img alt="image-20200309161110171" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnqs3f7mtj30on0c43zo.jpg" data-index="6" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnqs3f7mtj30on0c43zo.jpg"></p>
<h4 id="gt-gt-VAD-Structures"><a href="#gt-gt-VAD-Structures" class="headerlink" title="&gt;&gt; VAD Structures"></a>&gt;&gt; VAD Structures</h4><p>For each process, <code>_EPROCESS.VadRoot</code> points to the root of the VAD tree.</p>
<blockquote>
<p>the type of the member has frequently changed, as have the names of the VAD nodes. The differences are shown in Table below. For example, on Windows XP and 2003 Server, VadRoot pointed to an<code>_MMVAD_SHORT</code>, <code>_MMVAD</code>, or <code>_MMVAD_LONG</code>.</p>
</blockquote>
<p><img alt="image-20200309161744038" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnqyx67iqj30ol08uwft.jpg" data-index="7" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnqyx67iqj30ol08uwft.jpg"></p>
<p><code>_MM_AVL_TABLE</code>:</p>
<p><img alt="image-20200309164359492" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnrq8u3rnj30nz08a0uc.jpg" data-index="8" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnrq8u3rnj30nz08a0uc.jpg"></p>
<ul>
<li>You can see the <code>_MM_AVL_TABLE</code> has a BalancedRoot member, which is an <code>_MMADDRESS_NODE</code>.</li>
<li><strong><em>Each node</em> has a set of pointers to its child nodes and a <code>StartingVpn</code> and <code>EndingVpn</code>.</strong> From these <strong>virtual page numbers (VPNs)</strong>, you can derive the addresses of the first and last pages in the target process’ virtual memory.</li>
<li>VPNs are page numbers, not addresses.(To get the address, you have to multiply the page number by the size of a page.)</li>
</ul>
<p><code>_MMADDRESS_NODE(40 bytes)</code>:</p>
<p>It is an alias and it is really one of the <code>_MMVAD*</code>(short, regular, long)</p>
<p><img alt="image-20200309164742768" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnru4bhuqj30nu059757.jpg" data-index="9" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnru4bhuqj30nu059757.jpg"></p>
<p><code>_MMVAD_SHORT</code>:</p>
<p><img alt="image-20200309165155887" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnryihkurj30o507r0u3.jpg" data-index="10" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnryihkurj30o507r0u3.jpg"></p>
<p><code>_MMVAD</code>:</p>
<p><img alt="image-20200309165226422" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnrz1cz78j30ny0cpgo8.jpg" data-index="11" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnrz1cz78j30ny0cpgo8.jpg"></p>
<p><code>_MMVAD_LONG</code>:</p>
<p><img alt="image-20200309165303141" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnrzoc1uzj30ne037jrn.jpg" data-index="12" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnrzoc1uzj30ne037jrn.jpg"></p>
<p>and below:</p>
<p><img alt="image-20200309165317383" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnrzx8k6ij30ny0aptav.jpg" data-index="13" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnrzx8k6ij30ny0aptav.jpg"></p>
<p>a short node does not have a <code>Subsection</code>, thus it cannot possibly store a mapped file. </p>
<p>On the other hand, shell code that gets injected into a process never needs to exist on disk. </p>
<p>Thus, it won’t be backed by a file. As a result, <strong>if you’re hunting for code injection, you can probably ignore the regular and long nodes</strong>.</p>
<h4 id="gt-gt-VAD-Tags"><a href="#gt-gt-VAD-Tags" class="headerlink" title="&gt;&gt; VAD Tags"></a>&gt;&gt; VAD Tags</h4><p>After reading the structures above, you may wonder how Volatility determines which of the three <code>_MMVAD*</code> structures is aliased by an <code>_MMADDRESS_NODE</code>.</p>
<p>The answer is <code>Tag</code> member.(The offset of this member is -<code>0xc</code>)</p>
<blockquote>
<p>Indeed, this is a convenient hack allowed when defining structures with Volatility. Essentially what we’re doing is accessing the <code>PoolTag</code> member of the <code>_POOL_HEADER</code>, which exists in memory directly before the node.</p>
</blockquote>
<p>A mapping of VAD-Related Pool Tags to Strucrute type:</p>
<p><img alt="image-20200309171826693" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcnsq3c6zzj30of06ft94.jpg" data-index="14" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcnsq3c6zzj30of06ft94.jpg"></p>
<p><strong>Memory regions that contain injected shell code won’t be backed by a file. Thus, you would be looking for nodes with a VadS or VadF tag.</strong></p>
<h4 id="gt-gt-VAD-Flags"><a href="#gt-gt-VAD-Flags" class="headerlink" title="&gt;&gt; VAD Flags"></a>&gt;&gt; VAD Flags</h4><p>Each node has one or more sets of flags that contain characteristics about the memory range.(These flags are located in embedded unions named u, u1, u2, u3, and so on).</p>
<p>This name is based on <code>unnamed-tag</code> because unions don’t have associated types.</p>
<p><img alt="image-20200309174815086" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcntl3y1nrj30li0bitb9.jpg" data-index="15" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcntl3y1nrj30li0bitb9.jpg"></p>
<p>Bits 0 to 51 of the 8-byte value are for CommitCharge, and bits 56 to 61 are the Protection.</p>
<h4 id="gt-gt-CommitCharge"><a href="#gt-gt-CommitCharge" class="headerlink" title="&gt;&gt; CommitCharge"></a>&gt;&gt; CommitCharge</h4><p><code>CommitCharge</code> specifies the number of pages committed in the region described by the VAD node.</p>
<p>QUESTION:❓</p>
<p>The reason we care about this field is because historically when code injecting malware sets up the target process’ address space to receive the malicious code, it commits all pages up front—it doesn’t reserve them and then go back and commit them later (although it very well could). Thus, you can use these additional characteristics to help identify injected memory regions.</p>
<h4 id="gt-gt-Protection"><a href="#gt-gt-Protection" class="headerlink" title="&gt;&gt; Protection"></a>&gt;&gt; Protection</h4><p>This field indicates what type of access should be allowed to the memory region.</p>
<ul>
<li><p><code>PAGE_EXECUTE</code>: The memory can be executed, but not written. This protection cannot be used for mapped files.</p>
</li>
<li><p><code>PAGE_EXECUTE_READ</code>: The memory can be executed or read, but not written.</p>
</li>
<li><p><code>PAGE_EXECUTE_READWRITE</code>: The memory can be executed, read, or written. Injected code regions almost always have this protection.</p>
</li>
<li><p><code>PAGE_EXECUTE_WRITECOPY</code>: Enables execute, read-only, or copy-on-write access to a mapped view of a file. It cannot be set by calling <code>VirtualAlloc</code> or <code>VirtualAllocEx</code>. DLLs almost always have this protection.</p>
</li>
<li><p><code>PAGE_NOACCESS</code>: Disables all access to the memory. This protection cannot be used for mapped files. Applications can prevent accidental reads/writes to data by setting this protection.</p>
</li>
<li><p><code>PAGE_READONLY</code>: The memory can be read, but not executed or written. </p>
</li>
<li><code>PAGE_READWRITE</code>: The memory can be read or written, but not executed.</li>
<li><code>PAGE_WRITECOPY</code>: Enables read-only or copy-on-write access to a mapped view of a file. It cannot be set by calling VirtualAlloc or VirtualAllocEx.</li>
</ul>
<p>Note:</p>
<p>Protection field from the VAD <code>flags</code> is that it’s only the <strong>initial protection</strong> specified for all pages in the range when they were first reserved or committed. Thus, the current protection can be drastically different.</p>
<h4 id="gt-gt-Private-Memory"><a href="#gt-gt-Private-Memory" class="headerlink" title="&gt;&gt; Private Memory"></a>&gt;&gt; Private Memory</h4><p>Private memory, in this context, refers to committed regions that <strong>cannot typically be shared with or inherited by other processes</strong>.</p>
<ul>
<li>Mapped files, named shared memory, and copy-onwrite DLLs can be shared with other processes (although they may not be). <strong>Thus, if the <code>PrivateMemory</code> bit is set for a memory region, it does not contain one of the aforementioned types of data</strong>. </li>
<li>A process’ heaps, stacks, and ranges allocated with <code>VirtualAlloc</code> or <code>VirtualAllocEx</code> are usually marked as private.</li>
</ul>
<h4 id="gt-gt-Volatility-VAD-Plugins"><a href="#gt-gt-Volatility-VAD-Plugins" class="headerlink" title="&gt;&gt; Volatility VAD Plugins"></a>&gt;&gt; Volatility VAD Plugins</h4><ul>
<li><code>vadinfo</code> : Displays the most verbose output, including the starting and ending addresses, the protection level, flags, and full paths to mapped files or DLLs. </li>
</ul>
<p><img alt="image-20200310011133726" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gco6eevfzsj30pb07a75c.jpg" data-index="16" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gco6eevfzsj30pb07a75c.jpg"></p>
<ul>
<li><p><code>vadtree</code>: In text mode, this plugin prints a tree-view of the nodes, so you can see the parent and child relationships on your console. </p>
</li>
<li><p><code>vaddump</code> : <strong>Extracts the range of process memory each VAD node describes to a separate file on disk</strong>. Unlike memmap (discussed earlier), the output from this plugin is padded with zeros if any pages in the range are swapped to disk to maintain spatial integrity (offsets).</p>
</li>
</ul>

                </article>
                <ul class="tags-postTags">
                    
                    <li>
                        <a href="/tags/memory-forensics/" rel="tag"># memory forensics</a>
                    </li>
                    
                    <li>
                        <a href="/tags/notes/" rel="tag"># notes</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </div>

    
    <nav id="gobottom" class="pagination">
        
        <a class="prev-post" title="手把手带你MIT6.828 - Lab3" href="/2020/03/10/joslab3/">
            ← 手把手带你MIT6.828 - Lab3
        </a>
        
        <span class="prev-next-post">·</span>
        
        <a class="next-post" title="Processes, Handles, and Tokens" href="/2020/03/08/memfor-6/">
            Processes, Handles, and Tokens →
        </a>
        
    </nav>

    
    <div class="inner">
        <div id="comment"></div>
    </div>
    
</div>

<div class="toc-bar">
    <div class="toc-btn-bar">
        <a href="#site-main" class="toc-btn">
            <svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M793.024 710.272a32 32 0 1 0 45.952-44.544l-310.304-320a32 32 0 0 0-46.4 0.48l-297.696 320a32 32 0 0 0 46.848 43.584l274.752-295.328 286.848 295.808z"/></svg>
        </a>
        <div class="toc-btn toc-switch">
            <svg class="toc-open" viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M779.776 480h-387.2a32 32 0 0 0 0 64h387.2a32 32 0 0 0 0-64M779.776 672h-387.2a32 32 0 0 0 0 64h387.2a32 32 0 0 0 0-64M256 288a32 32 0 1 0 0 64 32 32 0 0 0 0-64M392.576 352h387.2a32 32 0 0 0 0-64h-387.2a32 32 0 0 0 0 64M256 480a32 32 0 1 0 0 64 32 32 0 0 0 0-64M256 672a32 32 0 1 0 0 64 32 32 0 0 0 0-64"/></svg>
            <svg class="toc-close hide" viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M512 960c-247.039484 0-448-200.960516-448-448S264.960516 64 512 64 960 264.960516 960 512 759.039484 960 512 960zM512 128.287273c-211.584464 0-383.712727 172.128262-383.712727 383.712727 0 211.551781 172.128262 383.712727 383.712727 383.712727 211.551781 0 383.712727-172.159226 383.712727-383.712727C895.712727 300.415536 723.551781 128.287273 512 128.287273z"/><path d="M557.05545 513.376159l138.367639-136.864185c12.576374-12.416396 12.672705-32.671738 0.25631-45.248112s-32.704421-12.672705-45.248112-0.25631l-138.560301 137.024163-136.447897-136.864185c-12.512727-12.512727-32.735385-12.576374-45.248112-0.063647-12.512727 12.480043-12.54369 32.735385-0.063647 45.248112l136.255235 136.671523-137.376804 135.904314c-12.576374 12.447359-12.672705 32.671738-0.25631 45.248112 6.271845 6.335493 14.496116 9.504099 22.751351 9.504099 8.12794 0 16.25588-3.103239 22.496761-9.247789l137.567746-136.064292 138.687596 139.136568c6.240882 6.271845 14.432469 9.407768 22.65674 9.407768 8.191587 0 16.352211-3.135923 22.591372-9.34412 12.512727-12.480043 12.54369-32.704421 0.063647-45.248112L557.05545 513.376159z"/></svg>
        </div>
        <a href="#gobottom" class="toc-btn">
            <svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M231.424 346.208a32 32 0 0 0-46.848 43.584l297.696 320a32 32 0 0 0 46.4 0.48l310.304-320a32 32 0 1 0-45.952-44.544l-286.848 295.808-274.752-295.36z"/></svg>
        </a>
    </div>
    <div class="toc-main">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Process-Memory-Internals"><span class="toc-text">7 Process Memory Internals</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-What’s-in-Process-Memory"><span class="toc-text">&gt; What’s in Process Memory?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-Allocation-APIs"><span class="toc-text">Memory Allocation APIs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Enumerating-Process-Memory"><span class="toc-text">&gt; Enumerating Process Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Process-Page-Tables"><span class="toc-text">&gt;&gt; Process Page Tables</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Virtual-Address-Descriptors"><span class="toc-text">&gt; Virtual Address Descriptors</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-VAD-Structures"><span class="toc-text">&gt;&gt; VAD Structures</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-VAD-Tags"><span class="toc-text">&gt;&gt; VAD Tags</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-VAD-Flags"><span class="toc-text">&gt;&gt; VAD Flags</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-CommitCharge"><span class="toc-text">&gt;&gt; CommitCharge</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Protection"><span class="toc-text">&gt;&gt; Protection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Private-Memory"><span class="toc-text">&gt;&gt; Private Memory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Volatility-VAD-Plugins"><span class="toc-text">&gt;&gt; Volatility VAD Plugins</span></a></li></ol></li></ol></li></ol>
    </div>
</div>



<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>




	</div>
	


<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
            

<article class="read-next-card" style="background-image: url(https://tva1.sinaimg.cn/large/00831rSTly1gcfvz62ikmj30u0140kjl.jpg)">
  <header class="read-next-card-header">
    <small class="read-next-card-header-sitetitle">&mdash; Icegrave &mdash;</small>
    <h3 class="read-next-card-header-title">Recent Posts</h3>
  </header>
  <div class="read-next-divider">
    <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24">
      <path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/>
    </svg>
  </div>
  <div class="read-next-card-content">
    <ul>
      
      
      
      <li>
        <a href="/2020/03/19/joslab4/">手把手带你MIT6.828 - Lab4</a>
      </li>
      
      
      
      <li>
        <a href="/2020/03/10/memfor-8/">Hunting Malware in Process Memory</a>
      </li>
      
      
      
      <li>
        <a href="/2020/03/10/joslab3/">手把手带你MIT6.828 - Lab3</a>
      </li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>
  </div>
  <footer class="read-next-card-footer">
    <a href="/archives">  MORE  → </a>
  </footer>
</article>

            
            
            

<article class="read-next-card" style="background-image: url(https://tva1.sinaimg.cn/large/00831rSTly1gcfvz62ikmj30u0140kjl.jpg)">
    <header class="read-next-card-header tagcloud-card">
        <h3 class="read-next-card-header-title">Categories</h3>
    </header>
    <div class="read-next-card-content">
        <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/memory-forensics/">memory forensics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/operating-system/">operating system</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/图形学基础/">图形学基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li></ul>
    </div>
</article>


            
            
            

<article class="read-next-card" style="background-image: url(https://tva1.sinaimg.cn/large/00831rSTly1gcfvz62ikmj30u0140kjl.jpg)">
	<header class="read-next-card-header tagcloud-card">
		<h3 class="read-next-card-header-title">Tag Cloud</h3>
	</header>
	<div class="read-next-card-content-ext">
		<a href="/tags/Fundamentals-of-Computer-Graphics/" style="font-size: 14px;">Fundamentals of Computer Graphics</a> <a href="/tags/iOS/" style="font-size: 14px;">iOS</a> <a href="/tags/iosre/" style="font-size: 14px;">iosre</a> <a href="/tags/lab/" style="font-size: 24px;">lab</a> <a href="/tags/memory-forensics/" style="font-size: 24px;">memory forensics</a> <a href="/tags/notes/" style="font-size: 24px;">notes</a> <a href="/tags/operating-system/" style="font-size: 24px;">operating system</a> <a href="/tags/工具/" style="font-size: 19px;">工具</a> <a href="/tags/随笔/" style="font-size: 14px;">随笔</a>
	</div>
</article>

            
        </div>
    </div>
</aside>

	




<div id="search" class="search-overlay">
    <div class="search-form">
        
        <div class="search-overlay-logo">
        	<img src="https://mubai.oss-cn-hangzhou.aliyuncs.com/icon.png" alt="Icegrave">
        </div>
        
        <input id="local-search-input" class="search-input" type="text" name="search" placeholder="Search ...">
        <a class="search-overlay-close" href="#"></a>
    </div>
    <div id="local-search-result"></div>
</div>

<footer class="site-footer outer">
	<div class="site-footer-content inner">
		<div class="copyright">
			<a href="/" title="Icegrave">Icegrave &copy; 2020</a>
			
				
			        <span hidden="true" id="/2020/03/09/memfor-7/" class="leancloud-visitors" data-flag-title="Process Memory Internals">
			            <span>阅读量 </span>
			            <span class="leancloud-visitors-count">0</span>
			        </span>
	    		
    		
		</div>
		<nav class="site-footer-nav">
			
			<a href="https://hexo.io" title="Hexo" target="_blank" rel="noopener">Hexo</a>
			<a href="https://github.com/xzhih/hexo-theme-casper" title="Casper" target="_blank" rel="noopener">Casper</a>
		</nav>
	</div>
</footer>
	


<script>
    if(window.navigator && navigator.serviceWorker) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                registration.unregister()
            }
        })
    }
</script>


<script id="scriptLoad" src="/js/allinone.min.js" async></script>


<script>
    document.getElementById('scriptLoad').addEventListener('load', function () {
        
        
            var bLazy = new Blazy();
        

        
        

        
        
        
            searchFunc("/");
        
        
    })
</script>



<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>




<script id="valineScript" src="//unpkg.com/valine/dist/Valine.min.js" async></script>
<script>
    document.getElementById('valineScript').addEventListener("load", function() {
        new Valine({
            el: '#comment' ,
            verify: false,
            notify: false,
            appId: 'PlliSVE5ISCj7XAYOowLuJDX-gzGzoHsz',
            appKey: 'CoE3u0Y1coO3kv6nHDpSuj4L',
            placeholder: 'nil',
            pageSize: 10,
            avatar: 'mm',
            visitor: true
        })
    });
</script>





</body>
</html>
