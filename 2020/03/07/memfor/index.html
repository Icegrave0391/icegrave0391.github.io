<!DOCTYPE html>
<html lang="zh-Hans">







<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="preconnect" href="//www.googletagmanager.com">
	<link rel="preconnect" href="//zz.bdstatic.com">
	<link rel="preconnect" href="//sp0.baidu.com">
	<link rel="preconnect" href="//www.google-analytics.com">
	<link rel="preconnect" href="//cdn1.lncld.net">
	<link rel="preconnect" href="//unpkg.com">
	<link rel="preconnect" href="//app-router.leancloud.cn">
	<link rel="preconnect" href="//9qpuwspm.api.lncld.net">
	<link rel="preconnect" href="//gravatar.loli.net">

	<title>Memory Forensics | Icegrave</title>

	<meta name="HandheldFriendly" content="True">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
	<meta name="generator" content="hexo">
	<meta name="author" content="Heart-Shaped Box">
	<meta name="description" content>

	
	<meta name="keywords" content>
	

	
	<link rel="shortcut icon" href="https://mubai.oss-cn-hangzhou.aliyuncs.com/icon.png">
	<link rel="apple-touch-icon" href="https://mubai.oss-cn-hangzhou.aliyuncs.com/icon.png">
	

	
	<meta name="theme-color" content="#3c484e">
	<meta name="msapplication-TileColor" content="#3c484e">
	

	

	

	<meta property="og:site_name" content="Icegrave">
	<meta property="og:type" content="article">
	<meta property="og:title" content="Memory Forensics | Icegrave">
	<meta property="og:description" content>
	<meta property="og:url" content="http://yoursite.com/2020/03/07/memfor/">

	
	<meta property="article:published_time" content="2020-03-07T17:03:00+08:00"> 
	<meta property="article:author" content="Heart-Shaped Box">
	<meta property="article:published_first" content="Icegrave, /2020/03/07/memfor/">
	

	
	
	<link rel="stylesheet" href="/css/allinonecss.min.css">

	
	
	
</head>
<body class="post-template">
	<div class="site-wrapper">
		




<header class="site-header post-site-header outer">
    <div class="inner">
        
<nav class="site-nav"> 
    <div class="site-nav-left">
        <ul class="nav">
            <li>
                
                <a href="/" title="Home">HOME</a>
                
            </li>
            
            
            <li>
                <a href="/about" title="ABOUT">ABOUT</a>
            </li>
            
            <li>
                <a href="/archives" title="ARCHIVES">ARCHIVES</a>
            </li>
            
            
        </ul> 
    </div>
    
    <div class="search-button-area">
        <a href="#search" class="search-button">Search ...</a>
    </div>
     
    <div class="site-nav-right">
        
        <a href="#search" class="search-button">Search ...</a>
         
        
<div class="social-links">
    
    <a class="social-link" title="weibo" href="https://weibo.com/" target="_blank" rel="noopener">
        <svg viewbox="0 0 1141 1024" xmlns="http://www.w3.org/2000/svg"><path d="M916.48 518.144q27.648 21.504 38.912 51.712t9.216 62.976-14.336 65.536-31.744 59.392q-34.816 48.128-78.848 81.92t-91.136 56.32-94.72 35.328-89.6 18.944-75.264 7.68-51.712 1.536-49.152-2.56-68.096-10.24-78.336-21.504-79.872-36.352-74.24-55.296-59.904-78.848q-16.384-29.696-22.016-63.488t-5.632-86.016q0-22.528 7.68-51.2t27.136-63.488 53.248-75.776 86.016-90.112q51.2-48.128 105.984-85.504t117.248-57.856q28.672-10.24 63.488-11.264t57.344 11.264q10.24 11.264 19.456 23.04t12.288 29.184q3.072 14.336 0.512 27.648t-5.632 26.624-5.12 25.6 2.048 22.528q17.408 2.048 33.792-1.536t31.744-9.216 31.232-11.776 33.28-9.216q27.648-5.12 54.784-4.608t49.152 7.68 36.352 22.016 17.408 38.4q2.048 14.336-2.048 26.624t-8.704 23.04-7.168 22.016 1.536 23.552q3.072 7.168 14.848 13.312t27.136 12.288 32.256 13.312 29.184 16.384zM658.432 836.608q26.624-16.384 53.76-45.056t44.032-64 18.944-75.776-20.48-81.408q-19.456-33.792-47.616-57.344t-62.976-37.376-74.24-19.968-80.384-6.144q-78.848 0-139.776 16.384t-105.472 43.008-72.192 60.416-38.912 68.608q-11.264 33.792-6.656 67.072t20.992 62.976 42.496 53.248 57.856 37.888q58.368 25.6 119.296 32.256t116.224 0.512 100.864-21.504 74.24-33.792zM524.288 513.024q20.48 8.192 38.912 18.432t32.768 27.648q10.24 12.288 17.92 30.72t10.752 39.424 1.536 42.496-9.728 38.912q-8.192 18.432-19.968 37.376t-28.672 35.328-40.448 29.184-57.344 18.944q-61.44 11.264-117.76-11.264t-88.064-74.752q-12.288-39.936-13.312-70.656t16.384-66.56q13.312-27.648 40.448-51.712t62.464-38.912 75.264-17.408 78.848 12.8zM361.472 764.928q37.888 3.072 57.856-18.432t21.504-48.128-15.36-47.616-52.736-16.896q-27.648 3.072-43.008 23.552t-17.408 43.52 9.728 42.496 39.424 21.504zM780.288 6.144q74.752 0 139.776 19.968t113.664 57.856 76.288 92.16 27.648 122.88q0 33.792-16.384 50.688t-35.328 17.408-35.328-14.336-16.384-45.568q0-40.96-22.528-77.824t-59.392-64.512-84.48-43.52-96.768-15.872q-31.744 0-47.104-15.36t-14.336-34.304 18.944-34.304 51.712-15.36zM780.288 169.984q95.232 0 144.384 48.64t49.152 146.944q0 30.72-10.24 43.52t-22.528 11.264-22.528-14.848-10.24-35.84q0-60.416-34.816-96.256t-93.184-35.84q-19.456 0-28.672-10.752t-9.216-23.04 9.728-23.04 28.16-10.752z"/></svg>
    </a>
    
    
    <a class="social-link" title="github" href="https://github.com/Icegrave0391" target="_blank" rel="noopener">
        <svg viewbox="0 0 1049 1024" xmlns="http://www.w3.org/2000/svg"><path d="M524.979332 0C234.676191 0 0 234.676191 0 524.979332c0 232.068678 150.366597 428.501342 358.967656 498.035028 26.075132 5.215026 35.636014-11.299224 35.636014-25.205961 0-12.168395-0.869171-53.888607-0.869171-97.347161-146.020741 31.290159-176.441729-62.580318-176.441729-62.580318-23.467619-60.841976-58.234462-76.487055-58.234463-76.487055-47.804409-32.15933 3.476684-32.15933 3.476685-32.15933 53.019436 3.476684 80.83291 53.888607 80.83291 53.888607 46.935238 79.963739 122.553122 57.365291 152.97411 43.458554 4.345855-33.897672 18.252593-57.365291 33.028501-70.402857-116.468925-12.168395-239.022047-57.365291-239.022047-259.012982 0-57.365291 20.860106-104.300529 53.888607-140.805715-5.215026-13.037566-23.467619-66.926173 5.215027-139.067372 0 0 44.327725-13.906737 144.282399 53.888607 41.720212-11.299224 86.917108-17.383422 131.244833-17.383422s89.524621 6.084198 131.244833 17.383422C756.178839 203.386032 800.506564 217.29277 800.506564 217.29277c28.682646 72.1412 10.430053 126.029806 5.215026 139.067372 33.897672 36.505185 53.888607 83.440424 53.888607 140.805715 0 201.64769-122.553122 245.975415-239.891218 259.012982 19.121764 16.514251 35.636014 47.804409 35.636015 97.347161 0 70.402857-0.869171 126.898978-0.869172 144.282399 0 13.906737 9.560882 30.420988 35.636015 25.205961 208.601059-69.533686 358.967656-265.96635 358.967655-498.035028C1049.958663 234.676191 814.413301 0 524.979332 0z"/></svg>
    </a>
    
    
    <a class="social-link" title="facebook" href="https://facebook" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

    </a>
    
    
    <a class="social-link" title="twitter" href="https://twitter.com" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

    </a>
    
    
    
    
</div>
    </div>
</nav>
    </div>
</header>


<div id="site-main" class="site-main outer" role="main">
    <div class="inner">
        <header class="post-full-header">
            <div class="post-full-meta">
                <time class="post-full-meta-date" datetime="2020-03-07T09:18:10.000Z">
                    2020-03-07
                </time>
                
                <span class="date-divider">/</span>
                
                <a href="/categories/memory-forensics/">memory forensics</a>&nbsp;&nbsp;
                
                
            </div>
            <h1 class="post-full-title">Memory Forensics</h1>
        </header>
        <div class="post-full ">
            
            <figure class="post-full-image" style="background-image: url(https://tva1.sinaimg.cn/large/00831rSTly1gclhs2jxcqj319m0n8ncd.jpg)">
            </figure>
            
            <div class="post-full-content">
                <article id="photoswipe" class="markdown-body">
                    <h1 id="Memory-Forensics"><a href="#Memory-Forensics" class="headerlink" title="Memory Forensics"></a>Memory Forensics</h1><h2 id="Basic-Knowledge"><a href="#Basic-Knowledge" class="headerlink" title="Basic Knowledge"></a>Basic Knowledge</h2><ul>
<li>PAE: physical adress extension</li>
<li>AS: Address spaces is an interface that provides flexible and consistent accsee to data in RAM.</li>
<li><code>_KDDEBUGGER_DATA64</code>: characteristics of the kernel debugger data block .</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DBGKD_DEBUG_DATA_HEADER64</span> &#123;</span> </span><br><span class="line">		LIST_ENTRY64 List; </span><br><span class="line">		ULONG OwnerTag; </span><br><span class="line">		ULONG Size; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Windows keeps a store of some useful global variables in a structure called <strong><code>_KDDEBUGGER_DATA64</code></strong>. This information is used by the microsoft kernel debugger in order to bootstap the analysis of a crash dump.</p>
<h2 id="Volatility"><a href="#Volatility" class="headerlink" title="Volatility"></a>Volatility</h2><h3 id="selecting-a-profile"><a href="#selecting-a-profile" class="headerlink" title="selecting a profile"></a>selecting a profile</h3><p>In some cases that you don’t know the profile ahead of time, volatility includes two plugins that can help you determine the proper profile.(Windows only)</p>
<ol>
<li><code>imageinfo</code></li>
</ol>
<p>instruction: <code>python vol.py -f [filename] imageinfo</code></p>
<p><img alt="image-20200306172125272" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gckby9o9q2j30ng0c23z7.jpg" data-index="0" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gckby9o9q2j30ng0c23z7.jpg"></p>
<blockquote>
<p>it also shows you the date and time when the memory sample was collected, the number of CPUS, some characteristics of the AS, such as whether PAE is enabled; and the directory table base (DTB) value used for address translation.</p>
</blockquote>
<ol>
<li>kdbgscan</li>
</ol>
<p>instruction: <code>python vol.py -f [filename] kdbgscan</code></p>
<p>The name of the plugin gives you an idea of how the potential profiles are guessed: It finds and analyzes characteristics of the kernel debugger data block (_KDDEBUGGER_DATA64).</p>
<p><img alt="image-20200306173632863" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gckcdzzmjhj30mc0j0myc.jpg" data-index="1" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gckcdzzmjhj30mc0j0myc.jpg"></p>
<hr>
<p>Now, you may supply <code>--profile=WinXPSP3x86</code> when running other plugins.</p>
<h3 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h3><p><code>python vol.py -f memory.dmp --profile=XXXX volshell</code></p>
<h2 id="Memory-Dump-Formats"><a href="#Memory-Dump-Formats" class="headerlink" title="Memory Dump Formats"></a>Memory Dump Formats</h2><p>The volatility franeworks also provides several plugins, for exploring the metadara associated with many of the common file formats:</p>
<p><img alt="image-20200306195815213" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gckghgcb5rj30q509q75x.jpg" data-index="2" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gckghgcb5rj30q509q75x.jpg"></p>
<h3 id="gt-Raw-Memory-Dump"><a href="#gt-Raw-Memory-Dump" class="headerlink" title="&gt; Raw Memory Dump"></a>&gt; Raw Memory Dump</h3><ul>
<li>The most widely supported format among analysis tools. </li>
<li>Does not contain any headers, metadata, or magic values for file type identification.</li>
<li>typically includes padding for any memory ranges that were intentionally skipped (i.e., device memory) or that could not be read by the acquisition tool, which helps maintain spatial integrity (relative offsets among data).</li>
</ul>
<h3 id="gt-Windows-Crash-Dump"><a href="#gt-Windows-Crash-Dump" class="headerlink" title="&gt; Windows Crash Dump"></a>&gt; Windows Crash Dump</h3><p>This file format was designed for debugging purposes. It begins with a <code>_DMP_HEADER</code> structure. 》 </p>
<blockquote>
<p>The header identifies the major and minor OS version, the kernel DTB(Directory  Table Base), the address of the active process and loaded kernel module list heads, and information on the physical memory runs.</p>
</blockquote>
<p><img alt="image-20200306200642283" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gckgq8q2mkj30o90d3goe.jpg" data-index="3" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gckgq8q2mkj30o90d3goe.jpg"></p>
<h3 id="gt-Windows-Hibernation-File"><a href="#gt-Windows-Hibernation-File" class="headerlink" title="&gt; Windows Hibernation File"></a>&gt; Windows Hibernation File</h3><p>A hibernation file (hiberfil.sys) contains a compressed copy of memory that the system dumps to disk during the hibernation process.</p>
<blockquote>
<p>Hibernation files consist of a standard header (PO_MEMORY_IMAGE), a set of kernel contexts and registers such as CR3, and several arrays of compressed data blocks.</p>
</blockquote>
<p>An example of the hibernation file header:</p>
<p><img alt="image-20200306202051606" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gckh508ml5j30lg08mdh7.jpg" data-index="4" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gckh508ml5j30lg08mdh7.jpg"></p>
<h3 id="gt-Virtual-Machine-Memory"><a href="#gt-Virtual-Machine-Memory" class="headerlink" title="&gt; Virtual Machine Memory"></a>&gt; Virtual Machine Memory</h3><p>To acquire memory from a VM, you can run one of the aforementioned software tools within the guest OS (VM) or you can perform the acquisition from the hypervisor. </p>
<h2 id="5-Windows-Objects-and-Pool-Allocations"><a href="#5-Windows-Objects-and-Pool-Allocations" class="headerlink" title="5 Windows Objects and Pool Allocations"></a>5 Windows Objects and Pool Allocations</h2><h3 id="gt-Windows-Executive-Objects"><a href="#gt-Windows-Executive-Objects" class="headerlink" title="&gt; Windows Executive Objects"></a>&gt; Windows Executive Objects</h3><p>Windows is written in C and makes heavy use of C structures to organize related data and attributes. Several of these structures are called executive objects because they are managed (created, protected, deleted, etc.) by the Windows Object Manager—a component of the kernel implemented by the NT module.</p>
<blockquote>
<p><strong>All executive objects are structures</strong>, but not all structures are executive objects.</p>
</blockquote>
<p>The most forensically relevant executive <strong>objects types</strong> are described below:</p>
<p><img alt="image-20200306205927113" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcki94tb52j30mr0mbdji.jpg" data-index="5" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcki94tb52j30mr0mbdji.jpg"></p>
<p><img alt="image-20200306205941411" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcki9dg2blj30mr0700ts.jpg" data-index="6" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcki9dg2blj30mr0700ts.jpg"></p>
<h4 id="gt-gt-Object-Headers"><a href="#gt-gt-Object-Headers" class="headerlink" title="&gt;&gt; Object Headers"></a>&gt;&gt; Object Headers</h4><ul>
<li>One of the common traits(特性) shared between all executive object types is the presence of an object header (<code>_OBJECT_HEADER</code>)</li>
<li>The <strong>object header immediately precedes the executive object structure in memory</strong>.</li>
</ul>
<p>Finding the structure (i.e.,<code>_FILE_OBJECT</code> in the figure) given the address of its <code>_OBJECT_HEADER</code>, or vice versa, is simple because the two are always directly adjacent; and the size of <code>_OBJECT_HEADER</code> is consistent per operating system.</p>
<p><img alt="image-20200306210659152" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gckigz0i1sj30lr0ggjte.jpg" data-index="7" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gckigz0i1sj30lr0ggjte.jpg"></p>
<p><img alt="image-20200306210737514" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gckihmt5gnj30j40bhgmy.jpg" data-index="8" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gckihmt5gnj30j40bhgmy.jpg"></p>
<ul>
<li><code>PointerCount</code>: Contains the <strong>total number of pointers to the object</strong>, including kernelmode references.</li>
<li><code>HandleCount</code>: Contains the number of <strong>open handles to the object</strong>.</li>
<li><code>TypeIndex</code>: This value tells you <strong>what type of object you’re dealing with</strong> (e.g., process, thread, file).</li>
<li><code>InfoMask</code>: This value <strong>tells you which of the optional headers</strong>, if any, are present.</li>
<li><code>SecurityDescriptor</code>: Stores information on the security restrictions for the object, such as which users can access it for reading, writing, deleting, and so on.</li>
<li><code>Body</code>: This member is just a placeholder that represents the start of the structure contained within the object.</li>
</ul>
<h4 id="gt-gt-Optional-Headers"><a href="#gt-gt-Optional-Headers" class="headerlink" title="&gt;&gt; Optional Headers"></a>&gt;&gt; Optional Headers</h4><p>An object’s optional headers contain various types of metadata that help describe the object.</p>
<p><img alt="image-20200306211042526" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gckiktybbxj30n50a3tac.jpg" data-index="9" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gckiktybbxj30n50a3tac.jpg"></p>
<h4 id="gt-gt-Object-Type-Objects"><a href="#gt-gt-Object-Type-Objects" class="headerlink" title="&gt;&gt; Object Type Objects"></a>&gt;&gt; Object Type Objects</h4><p>Firstly, we take a look at <code>_OBJECT_HEADER</code> and find a member <code>TypeIndex</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x18     : TypeIndex               [&apos;unsigned char&apos;]</span><br></pre></td></tr></table></figure>
<p>This member is an index into <code>nt!ObTypeIndexTable</code>.</p>
<ul>
<li><code>nt!ObTypeIndexTable</code> is an array of type objects(<code>_OBJECT_TYPE</code>), which we have shown above at the begin of this chapter.</li>
</ul>
<blockquote>
<p>This data is critical to memory forensics because you can use it to determine the type of object that follows an _OBJECT_HEADER.</p>
</blockquote>
<p><strong>Data Structures:</strong></p>
<p><img alt="image-20200307170307117" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gclh1j8t7nj30hx09d75y.jpg" data-index="10" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gclh1j8t7nj30hx09d75y.jpg"></p>
<ul>
<li><code>Name</code>: This is a <strong>Unicode string name of the object type</strong> (Process, File, Key, etc.). </li>
<li><p><code>TotalNumberOfObjects</code>: The total number of objects of this particular object type that exist on the system.</p>
</li>
<li><p><code>TotalNumberOfHandles</code>: The total number of open handles to objects of this particular type.</p>
</li>
<li><p><code>TypeInfo</code>: An _OBJECT_TYPE_INITIALIZER structure that tells you the <strong>type of memory</strong> used to allocate instances of these objects (for example, paged or nonpaged memory).</p>
</li>
<li><code>Key</code>: A four-byte tag that is <strong>used to uniquely mark memory allocations</strong> that contain objects of this particular type.</li>
</ul>
<blockquote>
<p>The <code>TypeInfo</code> and <code>Key</code> members provide two clues that will prove to be invaluable to memory forensics—<strong>they essentially tell you where to look (in paged or nonpaged memory) and what to look for</strong> (a specific four-byte tag) to find all instances of a particular object type (for example, all processes or all files).</p>
</blockquote>
<p><strong>demo:</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">python vol.py –f memory.dmp --profile=Win7SP1x64 volshell </span><br><span class="line">Volatile Systems Volatility Framework <span class="number">2.4</span> </span><br><span class="line">Current context: <span class="keyword">process</span> System, pid=<span class="number">4</span>, ppid=<span class="number">0</span> DTB=<span class="number">0</span>x187000 </span><br><span class="line">To get help, type <span class="string">'hh()'</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; kernel_space = addrspace()</span><br><span class="line">&gt;&gt;&gt; ObTypeIndexTable = <span class="number">0</span>xFFFFF80002870300</span><br><span class="line">&gt;&gt;&gt; ptrs = obj.Object(<span class="string">"Array"</span>, </span><br><span class="line">... 									targetType = <span class="string">"Pointer"</span>,</span><br><span class="line">... 									offset = ObTypeIndexTable,</span><br><span class="line">... 									count = <span class="number">100</span>,</span><br><span class="line">...					 					vm = kernel_space)</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; ptrs[<span class="number">0</span>] </span><br><span class="line">&lt;NoneObject pointer to [<span class="number">0</span>x00000000]&gt;</span><br><span class="line">&gt;&gt;&gt; ptrs[<span class="number">1</span>] </span><br><span class="line">&lt;NoneObject pointer to [<span class="number">0</span>xBAD0B0B0]&gt;</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">for</span> i, ptr <span class="keyword">in</span> enumerate(ptrs):</span><br><span class="line">... 		objtype = ptr.dereference_as(<span class="string">"_OBJECT_TYPE"</span>) </span><br><span class="line">... 		<span class="keyword">if</span> objtype.is_valid():</span><br><span class="line">... 				print i, str(objtype.Name), <span class="string">"in"</span>,</span><br><span class="line">... 								 str(objtype.TypeInfo.PoolType),</span><br><span class="line">... 								 <span class="string">"with key"</span>, </span><br><span class="line">...									 str(objtype.Key)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> Type <span class="keyword">in</span> NonPagedPool with key ObjT </span><br><span class="line"><span class="number">3</span> Directory <span class="keyword">in</span> PagedPool with key Dire </span><br><span class="line"><span class="number">4</span> SymbolicLink <span class="keyword">in</span> PagedPool with key Symb </span><br><span class="line"><span class="number">5</span> Token <span class="keyword">in</span> PagedPool with key Toke </span><br><span class="line"><span class="number">6</span> Job <span class="keyword">in</span> NonPagedPool with key Job </span><br><span class="line"><span class="number">7</span> <span class="keyword">Process</span> <span class="keyword">in</span> NonPagedPool with key Proc </span><br><span class="line"><span class="number">8</span> Thread <span class="keyword">in</span> NonPagedPool with key Thre </span><br><span class="line"><span class="number">9</span> UserApcReserve <span class="keyword">in</span> NonPagedPool with key User </span><br><span class="line"><span class="number">10</span> IoCompletionReserve <span class="keyword">in</span> NonPagedPool with key IoCo </span><br><span class="line"><span class="number">11</span> DebugObject <span class="keyword">in</span> NonPagedPool with key Debu </span><br><span class="line"><span class="number">12</span> Event <span class="keyword">in</span> NonPagedPool with key Even</span><br></pre></td></tr></table></figure>
<p>Note: We treated the data at kernel address 0xFFFFF80002870300 as an array of pointers to <code>_OBJECT_TYPE</code> structures.</p>
<ul>
<li><p>To get the address of 0xFFFFF80002870300 for the previous example, we typed</p>
<p><code>x nt!ObTypeIndexTable</code> into <code>Windbg</code>.</p>
</li>
<li><p>If don’t have Windbg, you can generate similar results by this: <code>python vol.py -f win7x64cmd.dd --profile=Win7SP0x64 objtypescan</code></p>
</li>
</ul>
<h3 id="gt-Kernel-Pool-Allocations"><a href="#gt-Kernel-Pool-Allocations" class="headerlink" title="&gt; Kernel Pool Allocations"></a>&gt; Kernel Pool Allocations</h3><p>A kernel pool is <strong>a range of memory that can be divided up into smaller blocks for storing any type of data that a kernel-mode component</strong> (the NT module, third-party device driver, etc.) requests.</p>
<ul>
<li>Similar to a heap, <strong>each allocated block has a header</strong> (<code>_POOL_HEADER</code>) that contains accounting and debugging information.</li>
</ul>
<p><img alt="image-20200307174538675" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcli9rw2c5j30iw0e8dho.jpg" data-index="11" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcli9rw2c5j30iw0e8dho.jpg"></p>
<p><strong>Data Structures of Pool Header:</strong></p>
<p><img alt="image-20200307175557004" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcliki40ydj30kw09tq4o.jpg" data-index="12" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcliki40ydj30kw09tq4o.jpg"></p>
<ul>
<li><p><code>BlockSize</code>: The <strong>total size of the allocation</strong>, including the pool header, object header, and any optional headers.</p>
</li>
<li><p><code>PoolType</code>: The <strong>type of system memory</strong> (paged, nonpaged, etc.) for which this pool header describes.</p>
</li>
<li><p><code>PoolTag</code>: A four-byte value, typically composed of ASCII characters that should uniquely identify the code path taken to produce the allocation (so troublesome blocks can be traced back to their source). </p>
</li>
</ul>
<h4 id="gt-gt-Allocation-APIs"><a href="#gt-gt-Allocation-APIs" class="headerlink" title="&gt;&gt; Allocation APIs"></a>&gt;&gt; Allocation APIs</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PVOID <span class="title">ExAllocatePoolWithTag</span><span class="params">( </span></span></span><br><span class="line"><span class="function"><span class="params">	_In_ POOL_TYPE PoolType,</span></span></span><br><span class="line"><span class="function"><span class="params">	_In_ SIZE_T NumberOfBytes, </span></span></span><br><span class="line"><span class="function"><span class="params">	_In_ ULONG Tag</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>The <code>PoolType</code> argument specifies the type of system memory to use for the allocation. NonPagedPool (0) and PagedPool (1) are the enumeration values for nonpageable and pageable memory, respectively. (As previously shown, most, but not all, executive object types are allocated using nonpageable memory)</p>
</li>
<li><p>The <code>NumberOfBytes</code> argument contains the number of bytes to allocate. Drivers that call <code>ExAllocatePoolWithTag()</code> directly can set this to the size of data they need to store in the memory block. </p>
<blockquote>
<p>Executive objects are different, as you have already learned, because they require extra space to store the object headers and optional headers. A function in the kernel named <code>ObCreateObject</code> is the central point from which all executive objects are created. It determines the size of the requested structure (i.e., 1232 bytes for an <code>_EPROCESS</code> on 64-bit Windows 7) and adds the size of <code>_OBJECT_HEADER</code> and any optional headers that need to be present before calling <code>ExAllocatePoolWithTag()</code>.</p>
</blockquote>
</li>
<li><p>The <code>Tag</code> argument specifies a four-byte value, typically composed of ASCII characters that should uniquely identify the code path taken to produce the allocation (so troublesome blocks can be traced back to their source).</p>
</li>
</ul>
<p><strong>The steps of Allocation using Windows API:</strong></p>
<ol>
<li>The process calls <code>CreateFileA</code>(ASCII) or <code>CreateFileW</code> (Unicode)—both are exported by <code>kernel32.dll</code>.</li>
<li>The create file APIs lead into <code>ntdll.dll</code>, which subsequently calls into the kernel and reaches the native <code>NtCreateFile</code> function.</li>
<li><code>NtCreateFile</code> will call <code>ObCreateObject</code> to request a new File object type.</li>
<li><code>ObCreateObject</code> calculates the size of <code>_FILE_OBJECT</code> , including the extra space needed for its optional headers.</li>
<li><code>ObCreateObject</code> finds the <code>_OBJECT_TYPE</code> structure for File objects and determines whether to allocate paged or nonpaged memory, as well as the four-byte tag to use.</li>
<li><code>ExAllocatePoolWithTag</code> is called with the appropriate size, memory type, and tag.</li>
</ol>
<p>After the steps, a new <code>_FILE_OBJECT</code> exists in memory.</p>
<p>A pointer to the object header is added to the <strong>calling process’ handle table</strong>, <strong>a system-wide pool</strong> tag tracking database is updated accordingly, and the individual members of the <code>_FILE_OBJECT</code> are initialized with the path to the file being created and the requested access permissions (e.g., read, write, delete).</p>
<h4 id="gt-gt-De-allocation-and-Reuse"><a href="#gt-gt-De-allocation-and-Reuse" class="headerlink" title="&gt;&gt; De-allocation and Reuse"></a>&gt;&gt; De-allocation and Reuse</h4><p><em>When blocks of pool memory are released, they are simply marked as free, not immediately overwritten.</em></p>
<p>The single most important factor is how soon the process indicates (by calling <code>CloseHandle</code>) that it is finished reading or writing the new file.</p>
<ul>
<li><p>At this time, if no other processes are using the file object, the block of memory will be released back to the pool’s “<strong>free list</strong>,” where it <strong>can be reallocated</strong> for a different purpose.</p>
<blockquote>
<p>While waiting to be reallocated, or at any time before new data is written to the memory block, much of the original <code>_FILE_OBJECT</code> will remain intact.</p>
</blockquote>
</li>
</ul>
<h3 id="gt-Pool-Tag-Scanning"><a href="#gt-Pool-Tag-Scanning" class="headerlink" title="&gt; Pool-Tag Scanning"></a>&gt; Pool-Tag Scanning</h3><p>Pool-tag scanning, or simply pool scanning, refers to finding allocations based on the aforementioned four-byte tags.</p>
<p>Pool scanning, involves <strong>searching the entire memory dump file for Proc (the four-byte tag associated with <code>_EPROCESS</code>)</strong>. The advantage to the latter method is that you can find historical entries (processes that are no longer running) as well as defeat some rootkit hiding techniques.</p>
<p>Notes: Four-byte tag is only the start. For scanning a certain process, we also need additional information.</p>
<blockquote>
<p>Volatility builds a more robust “signature” of what memory around the desired allocations looks like, and it’s based on the information described earlier in the chapter. </p>
<p>For example, <strong>the size of the allocation</strong> and <strong>type of memory</strong> (paged, nonpaged) play a large role in eliminating false positives. If you’re looking for a 100-byte <code>_EPROCESS</code> and find <code>Proc</code> inside a 30-byte allocation, it cannot possibly be a real process because the memory block is too small.</p>
</blockquote>
<h4 id="gt-gt-Pool-Tag-Sources"><a href="#gt-gt-Pool-Tag-Sources" class="headerlink" title="&gt;&gt; Pool Tag Sources"></a>&gt;&gt; Pool Tag Sources</h4><p>The initial criteria thar Volatility uses to find the listed executive objects via pool scanning:</p>
<p><img alt="image-20200307192732037" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcll7splzej30or0bgwgc.jpg" data-index="13" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcll7splzej30or0bgwgc.jpg"></p>
<p>Also, notice the Tag(Protected) column in Table above. </p>
<p>One of the most infrequently documented intricacies <strong>regarding pool tags is the protected bit</strong>. When you free a pool with <code>ExFreePoolWithTag</code>, you must supply the same tag supplied to <code>ExAllocatePoolWithTag</code>.</p>
<blockquote>
<p>This is a technique the operating system uses to prevent drivers from freeing memory by accident. If the tag passed to the free function doesn’t match, the system will raise an exception.</p>
</blockquote>
<h4 id="gt-gt-Pooltag-file"><a href="#gt-gt-Pooltag-file" class="headerlink" title="&gt;&gt; Pooltag file"></a>&gt;&gt; Pooltag file</h4><p>As previously mentioned, Microsoft created pool tags for debugging and auditing purposes. Thus, some installations of the Windows Driver Development Kit (DDK) and Debugging Tools for Windows include a <code>pooltag.txt</code> file that you can use to perform lookups. </p>
<h4 id="gt-gt-PoolMon-Utility"><a href="#gt-gt-PoolMon-Utility" class="headerlink" title="&gt;&gt; PoolMon Utility"></a>&gt;&gt; PoolMon Utility</h4><p>A memory pool monitor. It reports live updates about the pool tags that are in use on a system:</p>
<ul>
<li><p>The memory type (Paged or Nonpaged)</p>
</li>
<li><p>Number of allocations </p>
</li>
<li><p>Number of frees </p>
</li>
<li><p>Total number of bytes occupied by allocations</p>
</li>
<li><p>Average bytes per allocation</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\WinDDK\7600.16385.1\tools\Other\i386&gt; poolmon.exe -b</span><br></pre></td></tr></table></figure>
<p><img alt="image-20200307194403599" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcllozni70j30pv06ajso.jpg" data-index="14" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcllozni70j30pv06ajso.jpg"></p>
<p><strong>PoolMon is intended to provide real-time updates of changes in pool tag usage</strong>, it must be run on a live system. <strong>But what if you only have a memory dump?</strong> </p>
<p>Luckily, memory actually contains the statistics that PoolMon reads. They are accessible from the same kernel debugger data block (<code>_KDDEBUGGER_DATA64</code>) that stores the active process and loaded module lists.</p>
<h4 id="gt-gt-Pool-Tracker-Tables"><a href="#gt-gt-Pool-Tracker-Tables" class="headerlink" title="&gt;&gt; Pool Tracker Tables"></a>&gt;&gt; Pool Tracker Tables</h4><p>The PoolTrackTable member points to an array of <code>_POOL_TRACKER_TABLE</code> structures—<strong>one for each unique pool tag in use</strong>.</p>
<p><img alt="image-20200307194840141" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gclltsk52aj30mf076ab7.jpg" data-index="15" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gclltsk52aj30mf076ab7.jpg"></p>
<p>As you can see, each tracker table has a Key, which is the four-byte tag. The remaining members tell you how many allocations, frees, and total bytes are consumed for both nonpaged and paged memory.</p>
<p><strong>Although the information isn’t updated in real time</strong> (which makes sense because the system isn’t running anymore), you can at least <strong>determine its state at the time when the memory dump was acquired</strong>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python vol.py -f win7x64.dd pooltracker</span><br><span class="line">								  --profile=Win7SP0x64</span><br><span class="line">									--tags=Proc,File,Driv,Thre</span><br></pre></td></tr></table></figure>
<p>The column names start with “<strong>Np</strong>” for nonpaged or “<strong>Pg</strong>” for paged:</p>
<p><img alt="image-20200307195317976" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcllylo7cuj30kb05yt9d.jpg" data-index="16" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcllylo7cuj30kb05yt9d.jpg"></p>
<h4 id="gt-gt-Pool-Scanner-Algorighm"><a href="#gt-gt-Pool-Scanner-Algorighm" class="headerlink" title="&gt;&gt; Pool Scanner Algorighm"></a>&gt;&gt; Pool Scanner Algorighm</h4><p><img alt="image-20200307203454870" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcln5xu1unj30ev0jxq4u.jpg" data-index="17" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcln5xu1unj30ev0jxq4u.jpg"></p>
<p>If you scan using a physical address space, the code starts looking for the four-byte pool tag at offset 0 of the memory dump file and continues until it reaches the end of the file. Otherwise, if a virtual address space is selected, it enumerates and scans all pages in the kernel’s page table.</p>
<h4 id="gt-gt-Finding-Terminated-Processes"><a href="#gt-gt-Finding-Terminated-Processes" class="headerlink" title="&gt;&gt; Finding Terminated Processes"></a>&gt;&gt; Finding Terminated Processes</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python vol.py -f win7x64.dd --profile=Win7SP0x64 psscan</span><br></pre></td></tr></table></figure>
<p><img alt="image-20200307204659972" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gclnih5cwcj30oa0fegok.jpg" data-index="18" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gclnih5cwcj30oa0fegok.jpg"></p>
<h4 id="gt-gt-Limitations-of-Pool-Scanning"><a href="#gt-gt-Limitations-of-Pool-Scanning" class="headerlink" title="&gt;&gt; Limitations of Pool Scanning"></a>&gt;&gt; Limitations of Pool Scanning</h4><p><strong>Non-malicious Limitations</strong></p>
<ul>
<li><p><strong>Untagged pool memory</strong>: <code>ExAllocatePoolWithTag</code> is Microsoft’s recommended way for drivers and kernel-mode components to allocate memory, but it’s not the only option. A driver can also use <code>ExAllocatePool</code>, which is in the process of being deprecated, but is still available on many versions of Windows. <strong>This API allocates memory, but without a tag</strong>—leaving you no easy way to track or scan for the allocations.</p>
</li>
<li><p><strong>False positives</strong>: Because the pool-scanning technique is essentially based on pattern matching and heuristics, <strong>false positives are a possibility</strong>. This is especially true when scanning the physical address space because it includes data that the operating system discarded. To resolve false positives, you typically need to consider the context of the object (where it was found), if the member values make sense (this can vary per object), and if you found the object by other means such as alternate lists.</p>
</li>
<li><strong>Large allocations</strong>: The <strong>pool tag scanning technique does not work for allocations larger than 4096 bytes</strong> (see the upcoming section, “Big Page Pool”). Fortunately, all executive objects are less than this size.</li>
</ul>
<p><strong>Malicious Limitations (Anti-Forensics)</strong></p>
<ul>
<li><p><strong>Arbitrary tags</strong>: A driver can allocate memory <strong>using a generic, or default, tag</strong> such as “Ddk” (the last character is a space). This tag is used throughout the operating system and also third-party code when a tag is not specified. <strong>In other words, if malicious drivers use “Ddk” as their tag, the memory block will blend in with other allocations.</strong></p>
</li>
<li><p><strong>Decoy tags</strong>: As stated by Walters and Petroni (<a href="https://www.blackhat.com/presentations/bh-dc-07/Walters/Paper/bh-dc-07-Walters-WP.pdf" target="_blank" rel="noopener">https://www.blackhat.com/presentations/bh-dc-07/Walters/Paper/bh-dc-07-Walters-WP.pdf</a>) a driver <strong>can create fake (or decoy) objects that appear “life-like” to mislead investigators</strong>, effectively increasing the signal-to-noise ratio.</p>
</li>
<li><p><strong>Manipulated tags</strong>: Because tags are intended for debugging purposes, they aren’t critical for the stability of the operating system. <strong>Rootkits running in the kernel can modify pool tags</strong> (or any other value in the<code>_POOL_HEADER</code>, such as the block size and memory type) without any noticeable difference on the live machine, but the manipulation prevents Volatility’s pool scanner from working properly.</p>
</li>
</ul>
<h3 id="gt-Big-Page-Pool"><a href="#gt-Big-Page-Pool" class="headerlink" title="&gt; Big Page Pool"></a>&gt; Big Page Pool</h3><p>Windows kernel will try to group similarly sized allocations together. However, if the requested size exceeds one page (4096 bytes), the block of memory is allocated from a special pool (the big page pool) that is reserved for large allocations.</p>
<blockquote>
<p>In this case, the <code>_POOL_HEADER</code>, which contains the four-byte tag and exists at the base address for smaller allocations, is not used at all.</p>
</blockquote>
<p><img alt="image-20200307205528268" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gclnrammqkj30ny0g9wfq.jpg" data-index="19" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gclnrammqkj30ny0g9wfq.jpg"></p>
<h3 id="gt-Big-Page-Track-Tables"><a href="#gt-Big-Page-Track-Tables" class="headerlink" title="&gt; Big Page Track Tables"></a>&gt; Big Page Track Tables</h3><ul>
<li><p>The pool track tables ( <code>_POOL_TRACKER_TABLE</code>) for small memory blocks store statistics regarding the number of allocations and byte usage; but they don’t tell you the addresses of all the allocations (thus the need to scan). </p>
</li>
<li><p>Big page track tables, on the other hand, don’t store statistics, but they include the addresses of the allocations.</p>
</li>
</ul>
<p>the kernel symbol <code>nt!PoolBigPageTable</code>, which points to the array of <code>_POOL_TRACKER_BIG_PAGES</code> structures, (one for each large allocation), <strong>is neither exported nor copied to the kernel debugger data block</strong>.</p>
<p> However, <strong>this symbol can always be found at a predictable location relative to <code>nt!PoolTrackTable</code> (which is copied to the debugger data block).</strong> Thus, if you can find the pool track tables, you can find the big page track tables easily.</p>
<p><img alt="image-20200307205919311" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gclnvay4ejj30k504pq3l.jpg" data-index="20" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gclnvay4ejj30k504pq3l.jpg"></p>
<h4 id="gt-gt-Exploring-Big-Page-Pools"><a href="#gt-gt-Exploring-Big-Page-Pools" class="headerlink" title="&gt;&gt; Exploring Big Page Pools"></a>&gt;&gt; Exploring Big Page Pools</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python vol.py -f win7x64cmd.dd --profile=Win7SP0x64 bigpools &gt; bigpools.txt</span><br></pre></td></tr></table></figure>
<h2 id="6-Processes-Handles-and-Tokens"><a href="#6-Processes-Handles-and-Tokens" class="headerlink" title="6 Processes, Handles, and Tokens"></a>6 Processes, Handles, and Tokens</h2><p>This Chapter combines three of the most common initial steps in an investigation: determining what applications are running, what they’re doing(in terms of access to files, registry keys, and so on), and what security context(or privilege level) they have obtained.</p>
<h3 id="gt-Processes"><a href="#gt-Processes" class="headerlink" title="&gt; Processes"></a>&gt; Processes</h3><p>There are several of the basic resources that belong to a <strong>process</strong>:</p>
<p><img alt="image-20200308151829635" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmjn074wej30mj0gstao.jpg" data-index="21" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmjn074wej30mj0gstao.jpg"></p>
<ul>
<li><p><code>_EPROCESS</code>: the name of the structure that Windows uses to represent a process.</p>
<blockquote>
<p>all operating systems share the same concepts that are described in this high-level diagram.</p>
</blockquote>
</li>
<li><p>each process has its own private memory space that’s isolated from other processes.</p>
</li>
</ul>
<p>Inside this memory space, you can find the process executable; its list of loaded modules (DLLs or shared libraries); and its stacks, heaps, and allocated memory regions containing everything from user input to application-specific data structures.</p>
<ul>
<li>SIDs(security identifiers) and privilege data: a <strong>Security Identifier</strong> (commonly abbreviated <strong>SID</strong>) is a unique, immutable identifier of a user, user group, or other security principal.</li>
</ul>
<h4 id="gt-gt-Data-Structures"><a href="#gt-gt-Data-Structures" class="headerlink" title="&gt;&gt; Data Structures"></a>&gt;&gt; Data Structures</h4><p>Windows tracks processes by assigning them a unique <code>_EPROCESS</code> structure that resides in a <strong>non-paged pool</strong> of kernel memory.</p>
<p><img alt="image-20200308153340454" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmk2sm8tjj30lj0prwjk.jpg" data-index="22" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmk2sm8tjj30lj0prwjk.jpg"></p>
<p>and below:</p>
<p><img alt="image-20200308153352023" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmk2zufiwj30lq08u75q.jpg" data-index="23" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmk2zufiwj30lq08u75q.jpg"></p>
<ul>
<li><p><code>Pcb</code>: The <strong>kernel’s process control block</strong> (<code>_KPROCESS</code>). This structure is found at the base of <code>_EPROCESS</code> and contains several critical fields, including the DirectoryTableBase for address translation and the amount of time the process has spent in kernel mode and user mode.</p>
</li>
<li><p><code>CreateTime</code>: A UTC timestamp indicating when the process first started.</p>
</li>
<li><p><code>ExitTime</code>: A UTC timestamp indicating the time the process exited. <strong>This value is zero for still-running processes</strong>.</p>
</li>
<li><p><code>UniqueProcessId</code>: An integer that uniquely identifies the process (also known as the <strong>PID</strong>).</p>
</li>
<li><p><code>ActiveProcessLinks</code>: The <strong>doubly linked list that chains together active processes on the machine</strong>. Most APIs on a running system rely on walking this list. </p>
<blockquote>
<p>we can access all the process using <code>ActiveProcessLinks</code></p>
</blockquote>
</li>
<li><p><code>SessionProcessLinks</code>: Another doubly linked list that chains together processes in the same session.</p>
</li>
<li><p><code>InheritedFromUniqueProcessId</code>: An integer that specifies the <strong>PID of the parent process</strong>. After a process is running, this member is not modified, even if its parent terminates.</p>
</li>
<li><p><code>Session</code>: This member points to the <code>_MM_SESSION_SPACE</code> structure (see Chapter 14) that <strong>stores information on a user’s logon session and graphical user interface (GUI) objects.</strong></p>
</li>
<li><p><code>ImageFileName</code>: <strong>The filename portion of the process’ executable</strong>. This field stores the first 16 ASCII characters, so longer filenames will appear truncated. To get the full path to the executable, or to see the Unicode name, you can access the corresponding VAD node or members in the PEB (see Chapter 7).</p>
</li>
<li><p><code>ThreadListHead</code>: A doubly linked list that <strong>chains together all the process’ threads</strong> (each list element is an <code>_ETHREAD</code>).</p>
</li>
<li><p><code>ActiveThreads</code>: <strong>An integer indicating the number of active threads running in the process context</strong>. Seeing a process with zero active threads is a good sign that the process has exited.</p>
</li>
<li><p><code>Peb</code>: A pointer to the <strong>Process Environment Block (PEB)</strong>. Although this member (<code>_EPROCESS.Peb</code>) exists in kernel mode, it points to an address in user mode. <strong>The PEB contains pointers to the process’ DLL lists, current working directory, command line arguments, environment variables, heaps, and standard handles</strong>. </p>
</li>
<li><code>VadRoot</code>: The <strong>root node of the VAD tree</strong>. It contains detailed information <strong>about a process’ allocated memory segments, including the original access permissions</strong> (read, write, execute) and whether a file is mapped into the region.</li>
</ul>
<h4 id="gt-gt-Process-Organization"><a href="#gt-gt-Process-Organization" class="headerlink" title="&gt;&gt; Process Organization"></a>&gt;&gt; Process Organization</h4><p>The <code>_EPROCESS</code> structure contains a <code>_LIST_ENTRY</code> structure called <code>ActiveProcessLinks</code>.</p>
<p> The <code>_LIST_ENTRY</code> structure contains two members:</p>
<ul>
<li>Flink (forward link) that points to the <code>_LIST_ENTRY</code> of the next <code>_EPROCESS</code> structure</li>
<li>Blink (backward link) that points to the <code>_LIST_ENTRY</code> of the previous <code>_EPROCESS</code> structure.</li>
</ul>
<p><code>_LIST_ENTRY</code> structures:</p>
<p><img alt="image-20200308154619201" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmkfyh7iwj30nu0crdgn.jpg" data-index="24" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmkfyh7iwj30nu0crdgn.jpg"></p>
<p>Review:</p>
<p>To list processes, Volatility first locates the kernel debugger data block ( <code>_KDDEBUGGER_DATA64</code>). From there, it accesses the <code>PsActiveProcessHead</code> member, which points to the head of the doubly linked list of <code>_EPROCESS</code> structures. </p>
<p>We also discussed the pool-scanning approach in Chapter 5.</p>
<blockquote>
<p>In this chapter, we present many other ways to find processes in a memory dump. It is important to implement alternative methods because the debugger data block, the linked-list pointers, and the pool tags are all nonessential to OS stability—which means they can be manipulated (accidentally or intentionally) to defeat forensic tools without disrupting the system or its processes.</p>
</blockquote>
<h4 id="gt-gt-Critical-System-Processes"><a href="#gt-gt-Critical-System-Processes" class="headerlink" title="&gt;&gt; Critical System Processes"></a>&gt;&gt; Critical System Processes</h4><blockquote>
<p>if you know what’s normal, you can detect what’s abnormal more quickly</p>
</blockquote>
<p>So for now we’ll just focus on the theoretical concepts of how things should appear on clean systems.</p>
<ul>
<li><code>Idle</code> and <code>System</code>: These are not real processes (in the sense that they have no corresponding executable on disk). Idle is just a container that the kernel uses to charge CPU time for idle threads. Similarly, System serves as the default home for threads that run in kernel mode. Thus, the System process (PID 4) appears to own any sockets or handles to files that kernel modules open.</li>
<li><code>csrss.exe</code>: <strong>The client/server runtime subsystem plays a role in creating and deleting processes and threads</strong>. It maintains a private list of the objects that you can use to cross-reference with other data sources. </li>
<li><code>services.exe</code>: The Service Control Manager (SCM) in short, <strong>it manages Windows services and maintains a list of such services in its private memory space.</strong> This process should be the parent for any svchost.exe (service host) instances that you see, in addition to processes such as spoolsv.exe and SearchIndexer.exe that implement services. There should be only one copy of services.exe on a system, and it should be running from the system32 directory.</li>
<li><code>svchost.ex</code>e: A clean system has multiple shared host processes running concurrently, each providing a container for DLLs that implement services. As previously mentioned, their parent should be services.exe, and the path to their executable should point to the system32 directory. In his blog, Patrick identifies a few of the common names (such as scvhost.exe and svch0st.exe) used by malware to blend in with these processes.</li>
<li><code>lsass.exe</code>: The local security authority subsystem process is responsible for enforcing the security policy, verifying passwords, and creating access tokens. As such, it’s often the target of code injection because the plaintext password hashes can be found in its private memory space. There should be only one instance of lsass.exe running from the system32 directory, and its parent is winlogon.exe on pre-Vista machines, and wininit.exe on Vista and later systems. Stuxnet created two fake copies of lsass.exe, which caused them to stick out like a sore thumb.</li>
<li><code>winlogon</code>.exe : This process presents the interactive logon prompt, initiates the screen saver when necessary, helps load user profiles, and responds to Secure Attention Sequence (SAS) keyboard operations such as CTRL+ALT+DEL. Also, this process monitors files and directories for changes on systems that implement Windows File Protection (WFP). As with most other critical processes, its executable is located in the system32 directory.</li>
<li><code>explorer.exe</code>: You’ll see one Windows Explorer process for each logged-on user. It is responsible for handling a variety of user interactions such as GUI-based folder navigation, presenting the start menu, and so on. It also has access to sensitive material such as the documents you open and credentials you use to log in to FTP sites via Windows Explorer.</li>
<li><code>smss.exe</code>: The session manager is the first real user-mode process that starts during the boot sequence. It is responsible for creating the sessions (see Chapter 14) that isolate OS services from the various users who may log on via the console or Remote Desktop Protocol (RDP).</li>
</ul>
<h4 id="gt-gt-Analyzing-Process-Activity"><a href="#gt-gt-Analyzing-Process-Activity" class="headerlink" title="&gt;&gt; Analyzing Process Activity*"></a>&gt;&gt; Analyzing Process Activity*</h4><ul>
<li><code>pslist</code> <strong>finds and walks the doubly linked list of processes and prints a summary of the data.</strong> This method typically <strong>cannot show you terminated or hidden processes</strong>. </li>
<li><code>pstree</code> takes the output from pslist and formats it in a tree view, so you can easily see parent and child relationships.</li>
<li><code>psscan</code> <strong>scans for <code>_EPROCESS</code> objects instead of relying on the linked list</strong>. This plugin <strong>can also find terminated and unlinked (hidden) processes</strong>.</li>
<li><code>psxview</code> locates processes using alternate process listings, so you can then cross-reference different sources of information and reveal malicious discrepancies.</li>
</ul>
<h4 id="gt-gt-Process-Tree-Visualizations"><a href="#gt-gt-Process-Tree-Visualizations" class="headerlink" title="&gt;&gt; Process Tree Visualizations"></a>&gt;&gt; Process Tree Visualizations</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python vol.py psscan –f simple007.mem --profile=Win7SP1x64</span><br><span class="line">																	    --output=dot</span><br><span class="line">																	    --output-file=processes.dot</span><br><span class="line"></span><br><span class="line">⚙ chuqiz@Narny-6 =&gt; ~/Downloads/graphviz-2.40.1 =&gt; dot -Tsvg -o ~/tree.svg ~/Desktop/processes.dot</span><br></pre></td></tr></table></figure>
<p>Tree likes below：</p>
<p><img alt="image-20200308170307920" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmmnur1tmj31y60g0tbn.jpg" data-index="25" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmmnur1tmj31y60g0tbn.jpg"></p>
<h4 id="gt-gt-Detecting-DKOM-Attacks"><a href="#gt-gt-Detecting-DKOM-Attacks" class="headerlink" title="&gt;&gt; Detecting DKOM Attacks"></a>&gt;&gt; Detecting DKOM Attacks</h4><p>Many attacks are possible with Direct Kernel Object Manipulation (DKOM), but one of the most common is hiding a process by <strong>unlinking its entry from the doubly linked list</strong>. To accomplish this, overwrite the Flink and Blink pointers of surrounding objects so that they point around the <code>_EPROCESS</code> structure of the process to hide. Tools that execute on a running system and Volatility’s <code>pslist</code> command are susceptible to this attack, because they rely on the linked list. However, the <code>psscan</code> plugin uses the pool-scanning approach.</p>
<p><strong>Alternate Process Listing:</strong></p>
<ul>
<li><p><strong>Process object scanning</strong>: This is the pool-scanning approach discussed in Chapter 5. Remember that the pool tags it finds are nonessential; thus, they can also be manipulated to evade the scanner.</p>
</li>
<li><p><strong>Thread scanning</strong>: Because every process must have at least one active thread, you can scan for _ETHREAD objects and then map them back to their owning process. The member used for mapping is either _ETHREAD.ThreadsProcess (Windows XP and 2003) or _ETHREAD.Tcb.Process (Windows Vista and later). Thus, even if a rootkit manipulated the process’ pool tags to hide from psscan, it would also need to go back and modify the pool tags for all the process’ threads.</p>
</li>
<li><p><strong>CSRSS handle table</strong>: As discussed in the critical system process descriptions, csrss.exe is involved in the creation of every process and thread (with the exception of itself and the processes that started before it). Thus, you can walk this process’ handle table, as described later in the chapter, and identify all _EPROCESS objects that way.</p>
</li>
<li><p><strong>PspCid table</strong>: This is a special handle table located in kernel memory that stores a reference to all active process and thread objects. The PspCidTable member of the kernel debugger data structure points to the table. Two rootkit detection tools, Blacklight and IceSword, relied on the PspCid table to find hidden processes. However, the author of FUTo (see <a href="http://www.openrce.org/articles/full_view/19" target="_blank" rel="noopener">http://www.openrce.org/articles/full_view/19</a>) proved it was still possible to hide by removing processes from the table.</p>
</li>
<li><p><strong>Session processes</strong>: The SessionProcessLinks member of _EPROCESS associates all processes that belong to a particular user’s logon session. It’s not any harder to unlink a process from this list, as opposed to the ActiveProcessLinks list. But because live system APIs don’t depend on it, attackers rarely find value in targeting it.</p>
</li>
<li><p><strong>Desktop threads</strong>: One of the structures discussed in Chapter 14 is the Desktop (tagDESKTOP). These structures store a list of all threads attached to each desktop, and you can easily map a thread back to its owning process.</p>
</li>
</ul>
<p><strong>Process Cross-View Plugin</strong></p>
<p>The <code>psxview</code> plugin enumerates processes in seven different ways: the active process linked list and the six methods previously identified. Thus, it’s unlikely that a rootkit can successfully hide from <code>psxview</code>.</p>
<p><img alt="image-20200308163252517" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmlsdh8aqj30y40k240f.jpg" data-index="26" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmlsdh8aqj30y40k240f.jpg"></p>
<h3 id="gt-Process-Tokens"><a href="#gt-Process-Tokens" class="headerlink" title="&gt; Process Tokens"></a>&gt; Process Tokens</h3><p>A process’ token describes its security context. This context includes security identifiers (SIDs) of users or groups that the process is running as and the various privileges (specific tasks) that it is allowed to perform.</p>
<p>When the kernel needs to decide whether a process can access an object or call a particular API, it consults data in the process’ token.</p>
<h4 id="gt-gt-Data-Structures-1"><a href="#gt-gt-Data-Structures-1" class="headerlink" title="&gt;&gt; Data Structures"></a>&gt;&gt; Data Structures</h4><p>The <code>_TOKEN</code> structure is large, so we won’t display all the members.</p>
<p><img alt="image-20200308164700337" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmm72qyj8j30lm0judj3.jpg" data-index="27" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmm72qyj8j30lm0judj3.jpg"></p>
<p>and below:</p>
<p><img alt="image-20200308164716818" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmm7czsqbj30n30pi42j.jpg" data-index="28" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmm7czsqbj30n30pi42j.jpg"></p>
<ul>
<li><p><code>UserAndGroupCount</code>: This integer stores the size of the <code>UserAndGroups</code> array.</p>
</li>
<li><p><code>UserAndGroups</code>: An array of <code>_SID_AND_ATTRIBUTES</code> structures associated with the token. Each element in the array describes a different user or group that the process is a member of. The <code>Sid</code> member of <code>_SID_AND_ATTRIBUTES</code> points to a <code>_SID</code> structure, which has <code>IdentifierAuthority</code> and <code>SubAuthority</code> members that you can combine to form the S-1-5-[snip] SID strings.</p>
</li>
<li><p><code>PrivilegeCount</code> (Windows XP and 2003 only): This integer stores the size of the <code>Privileges</code> array.</p>
</li>
<li><p><code>Privileges</code> (Windows XP and 2003): An array of <code>_LUID_AND_ATTRIBUTES</code> structures</p>
<p>that each describe a different privilege and its attributes (that is, present, enabled, enabled by default).</p>
</li>
<li><p><code>Privileges</code> (Windows Vista and later): This is an instance of <code>_SEP_TOKEN_PRIVILEGES</code>, which has three parallel 64-bit values (Present, Enabled, EnabledByDefault). The bit positions correspond to particular privileges, and the values of the bit (on or off) describe the privilege’s status.</p>
</li>
</ul>
<h4 id="gt-gt-Accessing-Tokens"><a href="#gt-gt-Accessing-Tokens" class="headerlink" title="&gt;&gt; Accessing Tokens"></a>&gt;&gt; Accessing Tokens</h4><p>On a live machine, a process can access its own token through the <code>OpenProcessToken</code> API. To enumerate the SIDs or privileges, it can then use <code>GetTokenInformation</code> with the desired parameters. </p>
<p>With administrator access, it can also query (or set) the tokens of other users’ processes, including the system-critical ones. Of course, existing tools already provide this type of functionality for you, such as <strong>Sysinternals Process Explorer</strong>.</p>
<p><img alt="image-20200308171420415" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmmziqholj30df0g7juz.jpg" data-index="29" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmmziqholj30df0g7juz.jpg"></p>
<p>This instance of explorer.exe belongs to a user named Jimmy, whose SID string is <code>S-1-5-21-[snip]-1000</code>. By analyzing the other SIDs in this process’ token, you can see it’s also in the <code>Everyone</code>, <code>LOCAL</code>, and <code>NT AUTHORITY\Authenticated Users</code> groups.</p>
<h4 id="gt-gt-Extracting-and-Translating-SIDs-in-Memory"><a href="#gt-gt-Extracting-and-Translating-SIDs-in-Memory" class="headerlink" title="&gt;&gt; Extracting and Translating SIDs in Memory"></a>&gt;&gt; Extracting and Translating SIDs in Memory</h4><p>there are User SIDs such as S-1-5-21-4010035002-774237572-2085959976-1000. These SIDs break down into the following components:</p>
<ul>
<li>S: Prefix indicating that the string is a SID </li>
<li>1: The revision level (version of the SID specification) from <code>_SID.Revision</code> </li>
<li>5: The identifier authority value from <code>_SID.IdentifierAuthority.Value</code> </li>
<li>21-4010035002-774237572-2085959976: The local computer or domain identifier from the <code>_SID.SubAuthority</code> values </li>
<li>1000: A relative identifier that represents any user or group that doesn’t exist by default</li>
</ul>
<p>You can map the SID string to a username by querying the registry:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python vol.py -f memory.img --profile=Win7SP0x86 printkey -K &quot;Microsoft\Windows NT\CurrentVersion\ProfileList\S-1-5-21-4010035002-774237572-2085959976-1000&quot;</span><br></pre></td></tr></table></figure>
<p><img alt="image-20200308173111605" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmnh1ueklj30n80alta3.jpg" data-index="30" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmnh1ueklj30n80alta3.jpg"></p>
<h4 id="gt-gt-Detecting-Lateral-Movement"><a href="#gt-gt-Detecting-Lateral-Movement" class="headerlink" title="&gt;&gt; Detecting Lateral Movement"></a>&gt;&gt; Detecting Lateral Movement</h4><p>If you need to associate a process with a user account or investigate potential lateral movement attempts, use the getsids plugin.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ python vol.py –f grrcon.img --profile=WinXPSP3x86 getsids –p 1096</span><br><span class="line"></span><br><span class="line">explorer.exe: S-1-5-21-2682149276-1333600406-3352121115-500 (administrator) explorer.exe: S-1-5-21-2682149276-1333600406-3352121115-513 (Domain Users) explorer.exe: S-1-1-0 (Everyone) explorer.exe: S-1-5-32-545 (Users)</span><br><span class="line">explorer.exe: S-1-5-32-544 (Administrators) explorer.exe: S-1-5-4 (Interactive) explorer.exe: S-1-5-11 (Authenticated Users) explorer.exe: S-1-5-5-0-206541 (Logon Session) </span><br><span class="line">explorer.exe: S-1-2-0 (Local (Users with the ability to log in locally)) explorer.exe: S-1-5-21-2682149276-1333600406-3352121115-519 (Enterprise Admins) explorer.exe: S-1-5-21-2682149276-1333600406-3352121115-1115 </span><br><span class="line">explorer.exe: S-1-5-21-2682149276-1333600406-3352121115-518 (Schema Admins) explorer.exe: S-1-5-21-2682149276-1333600406-3352121115-512 (Domain Admins)</span><br></pre></td></tr></table></figure>
<p>This command shows the SIDs associated with explorer.exe for the current logged-on user.</p>
<h3 id="gt-Privileges"><a href="#gt-Privileges" class="headerlink" title="&gt; Privileges"></a>&gt; Privileges</h3><p>Privileges are another critical component involved in security and access control. A privilege is the permission to perform a specific task, such as debugging a process, shutting down the computer, changing the time zone, or loading a kernel driver.</p>
<p>Before a process can enable a privilege, the privilege must be present in the process’ token. Administrators decide which privileges are present by configuring them in the Local Security Policy (LSP),</p>
<p>You can access the LSP by going to Start ➪ Run and typing SecPol.msc:</p>
<p><img alt="image-20200308174427394" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmnuuh2ldj30gi0iadg7.jpg" data-index="31" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmnuuh2ldj30gi0iadg7.jpg"></p>
<p><img alt="image-20200308174509331" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmnvkq70mj30q60gmjva.jpg" data-index="32" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmnvkq70mj30q60gmjva.jpg"></p>
<p>In English:</p>
<p><img alt="image-20200308174533487" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmnvzwow0j30k80ak0ye.jpg" data-index="33" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmnvzwow0j30k80ak0ye.jpg"></p>
<p>From a forensic perspective, you should be most concerned with the following privileges when they’ve been explicitly enabled:</p>
<ul>
<li><code>SeBackupPrivilege</code>: This grants read <strong>access to any file on the file system</strong>, regardless of its specified access control list (ACL). Attackers can leverage this privilege to copy locked files.</li>
<li><p><code>SeDebugPrivilege</code>: This <strong>grants the ability to read from or write to another process’ private memory space</strong>. It <strong>allows malware to bypass the security boundaries that typically isolate processes</strong>. Practically all malware that performs code injection from user mode relies on enabling this privilege.</p>
</li>
<li><p><code>SeLoadDriverPrivilege</code>: This <strong>grants the ability to load or unload kernel drivers</strong>.</p>
</li>
<li><code>SeChangeNotifyPrivilege</code>: This <strong>allows the caller to register a callback function that gets executed when specific files and directories change.</strong> Attackers can use this to determine immediately when one of their configuration or executable files are removed by antivirus or administrators.</li>
<li><code>SeShutdownPrivilege</code>: This <strong>allows the caller to reboot or shut down the system</strong>. Some infections, such as those that modify the Master Boot Record (MBR) don’t activate until the next time the system boots. Thus, you’ll often see malware trying to manually speed up the procedure by invoking a reboot.</li>
</ul>
<h4 id="gt-gt-Analyzing-Explicit-Privileges"><a href="#gt-gt-Analyzing-Explicit-Privileges" class="headerlink" title="&gt;&gt; Analyzing Explicit Privileges"></a>&gt;&gt; Analyzing Explicit Privileges</h4><p>Here’s the output of the Volatility <code>privs</code> plugin. You’ll see the privilege name along with its attributes (present, enabled, and/or enabled by default):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python vol.py -f grrcon.img privs -p 1096</span><br></pre></td></tr></table></figure>
<p><img alt="image-20200308175020273" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmo0z63yvj30mv07swg1.jpg" data-index="34" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmo0z63yvj30mv07swg1.jpg"></p>
<p>and below:</p>
<p><img alt="image-20200308175027708" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmo13rnf6j30mm08qmza.jpg" data-index="35" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmo13rnf6j30mm08qmza.jpg"></p>
<p>You can see several privileges present in the output. Only six of them are enabled, but three are enabled by default.</p>
<h3 id="gt-Process-Handles"><a href="#gt-Process-Handles" class="headerlink" title="&gt; Process Handles"></a>&gt; Process Handles</h3><p>A handle is a reference to an open instance of a kernel object, such as a file, registry key, mutex, process, or thread.</p>
<blockquote>
<p>By enumerating and analyzing the specific objects a process was accessing at the time of a memory capture, it is possible to arrive at a number of forensically relevant conclusions—such as what process was reading or writing a particular file, what process accessed one of the registry run keys, and which process mapped remote file systems.</p>
</blockquote>
<h4 id="gt-gt-Lifetime-of-a-Handle"><a href="#gt-gt-Lifetime-of-a-Handle" class="headerlink" title="&gt;&gt; Lifetime of a Handle"></a>&gt;&gt; Lifetime of a Handle</h4><p>Before a process can access an object, it first opens a handle to the object by calling an API such as <code>CreateFile</code>, <code>RegOpenKeyEx</code>, or <code>CreateMutex</code>. These APIs return a special Windows data type called <code>HANDLE</code>, which is simply an index into a process-specific handle table.</p>
<p>For example, when you call <code>CreateFile</code>,</p>
<p> a pointer to the corresponding <code>_FILE_OBJECT</code> in kernel memory is placed in the first available slot in the calling process’ handle table, and the respective index (such as 0x40) is returned. Additionally, <strong>the handle count for the object is incremented</strong>. The calling process then passes the <code>HANDLE</code> value to functions that perform operations on the object, such as reading, writing, waiting, or deleting. Thus, APIs such as ReadFile and WriteFile work in the following manner:</p>
<ol>
<li>Find the base address of the calling process’ handle table.</li>
<li>Seek to index 0x40.</li>
<li>Retrieve the _FILE_OBJECT pointer.</li>
<li>Carry out the requested operation.</li>
</ol>
<p>When a process is finished using an object, it should close the handle by calling the appropriate function (<code>CloseHandle</code>, <code>RegCloseHandle</code>, and so on). These APIs <strong>decrement the object’s handle count</strong> and <strong>remove the pointer to the object from the process’ handle table</strong>.</p>
<p><strong>❓WHY USE HANDLE TABLE MODEL❓</strong></p>
<p>The handle table model was designed for both convenience and security.</p>
<ul>
<li>It’s convenient because <a href>you don’t have to pass the full name or path of an objec</a>t each time you perform an operation—only when you initially open or create the object. </li>
<li>For security purposes, it also helps to <strong>conceal the addresses of objects in kernel memory</strong>. Because processes in user mode should never directly access kernel objects, there’s no reason why they would need the pointers. </li>
<li>Furthermore, the model <strong>provides a centralized way for the kernel to monitor access to kernel objects</strong>, thus giving it the chance to enforce security based on SIDs and privileges.</li>
</ul>
<h4 id="gt-gt-Reference-Counts-and-Kernel-Handles"><a href="#gt-gt-Reference-Counts-and-Kernel-Handles" class="headerlink" title="&gt;&gt; Reference Counts and Kernel Handles"></a>&gt;&gt; Reference Counts and Kernel Handles</h4><p>So far in this section, we’ve been referring to processes as the entities that interact with objects <strong>via handles</strong>.</p>
<p>However, kernel modules, or threads in kernel mode, can call the equivalent kernel APIs (i.e., <code>NtCreateFile</code>, <code>NtReadFile</code>, <code>NtCreateMutex</code>) in a similar manner. In this case, the handles are <strong>allocated from the System (PID 4) process’ handle table.</strong> </p>
<blockquote>
<p>Thus, when you dump the handles of the System process, you’re <strong>actually seeing all the currently open resources requested by kernel modules.</strong></p>
</blockquote>
<ul>
<li><p>Even if handles are closed, and references are released, there’s still a chance that you can find the objects by scanning the physical address space (as described in Chapter 5).</p>
</li>
<li><p>Of course, they wouldn’t be associated with a process’ handle table at that point, but their <strong>presence in RAM can still lend clues to your investigations</strong>. </p>
<blockquote>
<p>Likewise, after a process terminates, its handle table is destroyed, but that doesn’t mean all objects created by the process are destroyed at the same time.</p>
</blockquote>
</li>
</ul>
<h4 id="gt-gt-Handle-Table-Internals"><a href="#gt-gt-Handle-Table-Internals" class="headerlink" title="&gt;&gt; Handle Table Internals"></a>&gt;&gt; Handle Table Internals</h4><p>Each process’ <code>_EPROCESS.ObjectTable</code> member <strong>points to a handle table</strong> ( <code>_HANDLE_TABLE</code>). This structure has a <code>TableCode</code> that serves two critical purposes: </p>
<ul>
<li>It <strong>specifies the number of levels in the table.</strong></li>
<li>It <strong>points to the base address of the first level.</strong> </li>
</ul>
<p>All processes start out with a single-level table, which is shown in Figure 6-12. The table size is one page (4096 bytes), and this scheme allows for up to 512 handles on a 32-bit system or 256 on a 64-bit system. Indexes in the table contain <code>_HANDLE_TABLE_ENTRY</code> structures if they’re in use; otherwise, they’re zeroed out.</p>
<p><img alt="image-20200308194859560" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmrgfjz3cj30o20dsabx.jpg" data-index="36" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmrgfjz3cj30o20dsabx.jpg"></p>
<p>Also, there are two-level even three-level table.</p>
<blockquote>
<p>You can image it as Page Directory and Page Table Entry and so on.</p>
</blockquote>
<h4 id="gt-gt-Data-Structures-2"><a href="#gt-gt-Data-Structures-2" class="headerlink" title="&gt;&gt; Data Structures"></a>&gt;&gt; Data Structures</h4><p><img alt="image-20200308195404675" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmrlq7r02j30m609bq4r.jpg" data-index="37" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmrlq7r02j30m609bq4r.jpg"></p>
<p>and below:</p>
<p><img alt="image-20200308195419291" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmrlytjh8j30mc0bjjtm.jpg" data-index="38" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmrlytjh8j30mc0bjjtm.jpg"></p>
<p>Some key points for <code>_HANDLE_TABLE</code>:</p>
<ul>
<li><code>TableCode</code>: This value <strong>tells you the number of levels in the table and points to the address of the top-level table</strong>. The dual purpose is achieved using a bit mask of seven (7). For example, to obtain the number of tables, you can compute TableCode &amp; 7; and to obtain the address, you can compute TableCode &amp; ~7. </li>
<li><code>QuotaProcess</code> : <strong>A pointer to the process to which the handle table belongs</strong>. It can come in handy if you find handle tables using the pool-scanning approach described in Chapter 5 rather than enumerating processes and following their ObjectTable pointer.</li>
<li><code>HandleTableList</code>: <strong>A linked list of process handle tables in kernel memory</strong>. You can use it to locate other handle tables—potentially even those for processes that have been unlinked from the process list.</li>
<li><code>HandleCount</code>: The <strong>total number of handle table entries</strong> that are currently in use by the process. This field was removed starting in Windows 8 and Server 2012.</li>
</ul>
<p>Some key points for <code>_HANDLE_TABLE_ENTRY</code>:</p>
<ul>
<li><p><code>Object</code>: This member points to the <code>_OBJECT_HEADER</code> of the corresponding object. The <code>_EX_FAST_REF</code> is a special data type that combines reference count information into the least significant bits of the pointer.</p>
</li>
<li><p><code>GrantedAccess</code>: A bit mask that specifies the granted access rights (read, write, delete, synchronize, etc.) that the owning process has obtained for the object.</p>
</li>
</ul>
<h3 id="gt-Enumerating-Handles-in-Memory"><a href="#gt-Enumerating-Handles-in-Memory" class="headerlink" title="&gt; Enumerating Handles in Memory*"></a>&gt; Enumerating Handles in Memory*</h3><p>The Volatility <code>handles</code> plugin generates output by walking the handle table data structures. There are a few filtering options:</p>
<ul>
<li><p>Filter by process ID: You can pass one or more (comma-separated) process IDs to the <code>-p/--pid</code> option.</p>
</li>
<li><p>Filter by process offset: You can supply the physical offset of an <code>_EPROCESS</code> structure to the <code>-o/--offset</code> option.</p>
</li>
<li><p>Filter by object type: If you’re interested in only a particular type of object, such as files or registry keys, you can specify the appropriate name(s) to the <code>-t/--object-type</code> option. See Chapter 5 or enter <code>!object \ObjectTypes</code> into Windbg to see the full list of object types.</p>
</li>
<li><p>Filter by name: Not all objects have names. Unnamed objects are obviously useless when searching for indicators by name, so one way to reduce noise is to use the <code>--silent</code> option, which suppresses handles to unnamed objects.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python vol.py -f zeus.vmem --profile=WinXPSP3x86 -p 632 handles</span><br></pre></td></tr></table></figure>
<p><img alt="image-20200308200304795" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmrv336bfj30o2036gly.jpg" data-index="39" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmrv336bfj30o2036gly.jpg"></p>
<p>and below:</p>
<p><img alt="image-20200308200316769" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmrvan7y9j30nw06iq44.jpg" data-index="40" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmrvan7y9j30nw06iq44.jpg"></p>
<p>As shown in the next example, you can limit your search to files and mutexes opened by PID 632 and ignore unnamed objects:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python vol.py -f zeus.vmem --profile=WinXPSP3x86 -p 632 handles</span><br><span class="line">		-t File,Mutant</span><br><span class="line">		--silent</span><br></pre></td></tr></table></figure>
<p><img alt="image-20200308200423716" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmrwge5e3j30o50df0vi.jpg" data-index="41" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmrwge5e3j30o50df0vi.jpg"></p>
<p>You see the user.ds and local.ds files, which contain the configuration and stolen data. The sdra64.exe file in the system32 directory is the initial Zeus installer.</p>
<blockquote>
<p>ou also may notice several open handles to <code>\Device\Tcp</code> and <code>\Device\Ip</code>. These are obviously different from the handles to files prefixed with <code>\Device\HarddiskVolume1</code>.</p>
<p>Specifically, Tcp and Ip are not files on the machine’s hard drive. This is described in Chapter 11, but what you’re essentially seeing are artifacts of network sockets that the process creates. Although sockets aren’t files, they support similar operations such as opening, reading, writing, and deleting. As a result, the same handle/descriptor subsystem can service both files and network sockets.</p>
<p>Along the same lines, <strong>named pipes are also represented as file objects</strong>. Thus, if malware creates a named pipe for interprocess communication or to redirect output of a backdoor command shell into a file, you can determine which processes are involved in that activity, provided that you <strong>know the name of the pipe it creates. In this case, it’s easy to identify because the name of the pipe that Zeus uses is the same as the standard mutex it creates to mark its presence on systems ( _AVIRA_)</strong>.</p>
</blockquote>
<h4 id="gt-gt-Detecting-Registry-Persistence"><a href="#gt-gt-Detecting-Registry-Persistence" class="headerlink" title="&gt;&gt; Detecting Registry Persistence"></a>&gt;&gt; Detecting Registry Persistence</h4><p>Malware often leverages the registry for persistence. To write the pertinent values, the malicious process must first open a handle to the desired registry key.</p>
<blockquote>
<p>you’ll see how obvious it is when malware chooses a well-known location (such as the Run key) and also suffers from a handle leak. You should not only recognize the registry key name but also the fact that you have numerous open handles to the same key.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python vol.py -f laqma.mem --profile=WinXPSP3x86 handles</span><br><span class="line">		--object-type=Key</span><br><span class="line">		--pid=1700</span><br></pre></td></tr></table></figure>
<p><img alt="image-20200308202015902" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmsd08hraj30o60j3win.jpg" data-index="42" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmsd08hraj30o60j3win.jpg"></p>
<blockquote>
<p>The process has nearly 20 open handles to the RUN key (not all are shown). This is indicative of a bug in the code that fails to close its handles after opening them.</p>
</blockquote>
<p>Of course, the artifacts won’t always be this obvious, and just because a handle to a key is open, that doesn’t mean the process added values. </p>
<p>However, you can always confirm your suspicions by using the <code>printkey</code> plugin (see Chapter 10) to look at the actual data that the key contains:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python vol.py -f laqma.mem printkey -K &quot;MICROSOFT\WINDOWS\CURRENTVERSION\RUN&quot;</span><br></pre></td></tr></table></figure>
<p><img alt="image-20200308202735782" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmsklhwp0j30nw0deac5.jpg" data-index="43" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmsklhwp0j30nw0deac5.jpg"></p>
<p>Based on their names, the final two entries seem suspicious—they cause <code>lanmanwrk.exe</code> and <code>KernelDrv.exe</code> to start automatically at each boot.</p>
<h4 id="gt-gt-Identifying-Remote-Mapped-Drives"><a href="#gt-gt-Identifying-Remote-Mapped-Drives" class="headerlink" title="&gt;&gt; Identifying Remote Mapped Drives"></a>&gt;&gt; Identifying Remote Mapped Drives</h4><p>Many adversaries rely on commands such as <code>net view</code> and <code>net use</code> to explore the surrounding network and map remote drives. </p>
<p>Obtaining read access to a company’s Server Message Block (SMB) file server or write access to various other workstations or servers in an enterprise can lead to successful lateral movement.</p>
<ul>
<li>The following example shows <strong>how an attacker navigates the network to mount two remote drives</strong>. The Users directory of a system named WIN-464MMR8O7GF is mounted on P, and the C$ share of a system named LH-7J277PJ9J85I is mounted at Q:</li>
</ul>
<p><img alt="image-20200308203556523" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmsta2ujuj30m70ic0v9.jpg" data-index="44" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmsta2ujuj30m70ic0v9.jpg"></p>
<ul>
<li><p><strong>The trick to finding evidence of remote mapped drives in memory</strong> is to look for file handles prefixed with <code>\Device\Mup</code> and <code>\Device\LanmanRedirector</code>:</p>
<blockquote>
<p>MUP, which stands for Multiple Universal Naming Convention (UNC) Provider, is a kernel-mode component that channels requests to access remote files using UNC names to the appropriate network redirector. In this case, <code>LanmanRedirector</code> handles the SMB protocol.</p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python vol.py -f hop.mem --profile=VistaSP2x64 handles -t File | grep Mup</span><br></pre></td></tr></table></figure>
<p><img alt="image-20200308204050322" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/00831rSTly1gcmsydpfuej30o10a9aby.jpg" data-index="45" data-src="https://tva1.sinaimg.cn/large/00831rSTly1gcmsydpfuej30o10a9aby.jpg"></p>
<p>You have several plain handles to \Device\Mup (they are normal). The few in bold are the ones you should find interesting because they actually display the local drive letter, the remote NetBIOS name, and the share or file system path name. </p>
<blockquote>
<p>There are also two different process IDs shown: 752 and 1544. In this case, 752 is the instance of svchost.exe that runs the LanmanWorkstation service; it creates and maintains client network connections to remote servers using the SMB protocol. PID 1544 is the cmd.exe shell, and it has a handle to <code>C$\Users\Jimmy\Documents</code> as a result of the attacker changing into that directory.</p>
</blockquote>

                </article>
                <ul class="tags-postTags">
                    
                    <li>
                        <a href="/tags/工具/" rel="tag"># 工具</a>
                    </li>
                    
                    <li>
                        <a href="/tags/memory-forensics/" rel="tag"># memory forensics</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </div>

    
    <nav id="gobottom" class="pagination">
        
        <span class="prev-next-post">·</span>
        
        <a class="next-post" title="手把手带你MIT6.828 - Lab2" href="/2020/03/04/lab2/">
            手把手带你MIT6.828 - Lab2 →
        </a>
        
    </nav>

    
    <div class="inner">
        <div id="comment"></div>
    </div>
    
</div>

<div class="toc-bar">
    <div class="toc-btn-bar">
        <a href="#site-main" class="toc-btn">
            <svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M793.024 710.272a32 32 0 1 0 45.952-44.544l-310.304-320a32 32 0 0 0-46.4 0.48l-297.696 320a32 32 0 0 0 46.848 43.584l274.752-295.328 286.848 295.808z"/></svg>
        </a>
        <div class="toc-btn toc-switch">
            <svg class="toc-open" viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M779.776 480h-387.2a32 32 0 0 0 0 64h387.2a32 32 0 0 0 0-64M779.776 672h-387.2a32 32 0 0 0 0 64h387.2a32 32 0 0 0 0-64M256 288a32 32 0 1 0 0 64 32 32 0 0 0 0-64M392.576 352h387.2a32 32 0 0 0 0-64h-387.2a32 32 0 0 0 0 64M256 480a32 32 0 1 0 0 64 32 32 0 0 0 0-64M256 672a32 32 0 1 0 0 64 32 32 0 0 0 0-64"/></svg>
            <svg class="toc-close hide" viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M512 960c-247.039484 0-448-200.960516-448-448S264.960516 64 512 64 960 264.960516 960 512 759.039484 960 512 960zM512 128.287273c-211.584464 0-383.712727 172.128262-383.712727 383.712727 0 211.551781 172.128262 383.712727 383.712727 383.712727 211.551781 0 383.712727-172.159226 383.712727-383.712727C895.712727 300.415536 723.551781 128.287273 512 128.287273z"/><path d="M557.05545 513.376159l138.367639-136.864185c12.576374-12.416396 12.672705-32.671738 0.25631-45.248112s-32.704421-12.672705-45.248112-0.25631l-138.560301 137.024163-136.447897-136.864185c-12.512727-12.512727-32.735385-12.576374-45.248112-0.063647-12.512727 12.480043-12.54369 32.735385-0.063647 45.248112l136.255235 136.671523-137.376804 135.904314c-12.576374 12.447359-12.672705 32.671738-0.25631 45.248112 6.271845 6.335493 14.496116 9.504099 22.751351 9.504099 8.12794 0 16.25588-3.103239 22.496761-9.247789l137.567746-136.064292 138.687596 139.136568c6.240882 6.271845 14.432469 9.407768 22.65674 9.407768 8.191587 0 16.352211-3.135923 22.591372-9.34412 12.512727-12.480043 12.54369-32.704421 0.063647-45.248112L557.05545 513.376159z"/></svg>
        </div>
        <a href="#gobottom" class="toc-btn">
            <svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M231.424 346.208a32 32 0 0 0-46.848 43.584l297.696 320a32 32 0 0 0 46.4 0.48l310.304-320a32 32 0 1 0-45.952-44.544l-286.848 295.808-274.752-295.36z"/></svg>
        </a>
    </div>
    <div class="toc-main">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Memory-Forensics"><span class="toc-text">Memory Forensics</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-Knowledge"><span class="toc-text">Basic Knowledge</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Volatility"><span class="toc-text">Volatility</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#selecting-a-profile"><span class="toc-text">selecting a profile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shell"><span class="toc-text">shell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memory-Dump-Formats"><span class="toc-text">Memory Dump Formats</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Raw-Memory-Dump"><span class="toc-text">&gt; Raw Memory Dump</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Windows-Crash-Dump"><span class="toc-text">&gt; Windows Crash Dump</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Windows-Hibernation-File"><span class="toc-text">&gt; Windows Hibernation File</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Virtual-Machine-Memory"><span class="toc-text">&gt; Virtual Machine Memory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Windows-Objects-and-Pool-Allocations"><span class="toc-text">5 Windows Objects and Pool Allocations</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Windows-Executive-Objects"><span class="toc-text">&gt; Windows Executive Objects</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Object-Headers"><span class="toc-text">&gt;&gt; Object Headers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Optional-Headers"><span class="toc-text">&gt;&gt; Optional Headers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Object-Type-Objects"><span class="toc-text">&gt;&gt; Object Type Objects</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Kernel-Pool-Allocations"><span class="toc-text">&gt; Kernel Pool Allocations</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Allocation-APIs"><span class="toc-text">&gt;&gt; Allocation APIs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-De-allocation-and-Reuse"><span class="toc-text">&gt;&gt; De-allocation and Reuse</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Pool-Tag-Scanning"><span class="toc-text">&gt; Pool-Tag Scanning</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Pool-Tag-Sources"><span class="toc-text">&gt;&gt; Pool Tag Sources</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Pooltag-file"><span class="toc-text">&gt;&gt; Pooltag file</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-PoolMon-Utility"><span class="toc-text">&gt;&gt; PoolMon Utility</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Pool-Tracker-Tables"><span class="toc-text">&gt;&gt; Pool Tracker Tables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Pool-Scanner-Algorighm"><span class="toc-text">&gt;&gt; Pool Scanner Algorighm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Finding-Terminated-Processes"><span class="toc-text">&gt;&gt; Finding Terminated Processes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Limitations-of-Pool-Scanning"><span class="toc-text">&gt;&gt; Limitations of Pool Scanning</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Big-Page-Pool"><span class="toc-text">&gt; Big Page Pool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Big-Page-Track-Tables"><span class="toc-text">&gt; Big Page Track Tables</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Exploring-Big-Page-Pools"><span class="toc-text">&gt;&gt; Exploring Big Page Pools</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Processes-Handles-and-Tokens"><span class="toc-text">6 Processes, Handles, and Tokens</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Processes"><span class="toc-text">&gt; Processes</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Data-Structures"><span class="toc-text">&gt;&gt; Data Structures</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Process-Organization"><span class="toc-text">&gt;&gt; Process Organization</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Critical-System-Processes"><span class="toc-text">&gt;&gt; Critical System Processes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Analyzing-Process-Activity"><span class="toc-text">&gt;&gt; Analyzing Process Activity*</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Process-Tree-Visualizations"><span class="toc-text">&gt;&gt; Process Tree Visualizations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Detecting-DKOM-Attacks"><span class="toc-text">&gt;&gt; Detecting DKOM Attacks</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Process-Tokens"><span class="toc-text">&gt; Process Tokens</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Data-Structures-1"><span class="toc-text">&gt;&gt; Data Structures</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Accessing-Tokens"><span class="toc-text">&gt;&gt; Accessing Tokens</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Extracting-and-Translating-SIDs-in-Memory"><span class="toc-text">&gt;&gt; Extracting and Translating SIDs in Memory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Detecting-Lateral-Movement"><span class="toc-text">&gt;&gt; Detecting Lateral Movement</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Privileges"><span class="toc-text">&gt; Privileges</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Analyzing-Explicit-Privileges"><span class="toc-text">&gt;&gt; Analyzing Explicit Privileges</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Process-Handles"><span class="toc-text">&gt; Process Handles</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Lifetime-of-a-Handle"><span class="toc-text">&gt;&gt; Lifetime of a Handle</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Reference-Counts-and-Kernel-Handles"><span class="toc-text">&gt;&gt; Reference Counts and Kernel Handles</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Handle-Table-Internals"><span class="toc-text">&gt;&gt; Handle Table Internals</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Data-Structures-2"><span class="toc-text">&gt;&gt; Data Structures</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gt-Enumerating-Handles-in-Memory"><span class="toc-text">&gt; Enumerating Handles in Memory*</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Detecting-Registry-Persistence"><span class="toc-text">&gt;&gt; Detecting Registry Persistence</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-Identifying-Remote-Mapped-Drives"><span class="toc-text">&gt;&gt; Identifying Remote Mapped Drives</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>
</div>



<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>




	</div>
	


<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
            

<article class="read-next-card" style="background-image: url(https://tva1.sinaimg.cn/large/00831rSTly1gcfvz62ikmj30u0140kjl.jpg)">
  <header class="read-next-card-header">
    <small class="read-next-card-header-sitetitle">&mdash; Icegrave &mdash;</small>
    <h3 class="read-next-card-header-title">Recent Posts</h3>
  </header>
  <div class="read-next-divider">
    <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24">
      <path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/>
    </svg>
  </div>
  <div class="read-next-card-content">
    <ul>
      
      
      
      <li>
        <a href="/2020/03/07/memfor/">Memory Forensics</a>
      </li>
      
      
      
      <li>
        <a href="/2020/03/04/lab2/">手把手带你MIT6.828 - Lab2</a>
      </li>
      
      
      
      <li>
        <a href="/2020/03/02/os/">手把手带你MIT6.828 - Lab1</a>
      </li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>
  </div>
  <footer class="read-next-card-footer">
    <a href="/archives">  MORE  → </a>
  </footer>
</article>

            
            
            

<article class="read-next-card" style="background-image: url(https://tva1.sinaimg.cn/large/00831rSTly1gcfvz62ikmj30u0140kjl.jpg)">
    <header class="read-next-card-header tagcloud-card">
        <h3 class="read-next-card-header-title">Categories</h3>
    </header>
    <div class="read-next-card-content">
        <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/memory-forensics/">memory forensics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/operating-system/">operating system</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/图形学基础/">图形学基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li></ul>
    </div>
</article>


            
            
            

<article class="read-next-card" style="background-image: url(https://tva1.sinaimg.cn/large/00831rSTly1gcfvz62ikmj30u0140kjl.jpg)">
	<header class="read-next-card-header tagcloud-card">
		<h3 class="read-next-card-header-title">Tag Cloud</h3>
	</header>
	<div class="read-next-card-content-ext">
		<a href="/tags/Fundamentals-of-Computer-Graphics/" style="font-size: 14px;">Fundamentals of Computer Graphics</a> <a href="/tags/iOS/" style="font-size: 14px;">iOS</a> <a href="/tags/iosre/" style="font-size: 14px;">iosre</a> <a href="/tags/lab/" style="font-size: 19px;">lab</a> <a href="/tags/memory-forensics/" style="font-size: 14px;">memory forensics</a> <a href="/tags/operating-system/" style="font-size: 19px;">operating system</a> <a href="/tags/工具/" style="font-size: 24px;">工具</a> <a href="/tags/随笔/" style="font-size: 14px;">随笔</a>
	</div>
</article>

            
        </div>
    </div>
</aside>

	




<div id="search" class="search-overlay">
    <div class="search-form">
        
        <div class="search-overlay-logo">
        	<img src="https://mubai.oss-cn-hangzhou.aliyuncs.com/icon.png" alt="Icegrave">
        </div>
        
        <input id="local-search-input" class="search-input" type="text" name="search" placeholder="Search ...">
        <a class="search-overlay-close" href="#"></a>
    </div>
    <div id="local-search-result"></div>
</div>

<footer class="site-footer outer">
	<div class="site-footer-content inner">
		<div class="copyright">
			<a href="/" title="Icegrave">Icegrave &copy; 2020</a>
			
				
			        <span hidden="true" id="/2020/03/07/memfor/" class="leancloud-visitors" data-flag-title="Memory Forensics">
			            <span>阅读量 </span>
			            <span class="leancloud-visitors-count">0</span>
			        </span>
	    		
    		
		</div>
		<nav class="site-footer-nav">
			
			<a href="https://hexo.io" title="Hexo" target="_blank" rel="noopener">Hexo</a>
			<a href="https://github.com/xzhih/hexo-theme-casper" title="Casper" target="_blank" rel="noopener">Casper</a>
		</nav>
	</div>
</footer>
	


<script>
    if(window.navigator && navigator.serviceWorker) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                registration.unregister()
            }
        })
    }
</script>


<script id="scriptLoad" src="/js/allinone.min.js" async></script>


<script>
    document.getElementById('scriptLoad').addEventListener('load', function () {
        
        
            var bLazy = new Blazy();
        

        
        

        
        
        
            searchFunc("/");
        
        
    })
</script>



<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>




<script id="valineScript" src="//unpkg.com/valine/dist/Valine.min.js" async></script>
<script>
    document.getElementById('valineScript').addEventListener("load", function() {
        new Valine({
            el: '#comment' ,
            verify: false,
            notify: false,
            appId: 'PlliSVE5ISCj7XAYOowLuJDX-gzGzoHsz',
            appKey: 'CoE3u0Y1coO3kv6nHDpSuj4L',
            placeholder: 'nil',
            pageSize: 10,
            avatar: 'mm',
            visitor: true
        })
    });
</script>





</body>
</html>
